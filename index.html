<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvenTrack Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body style="margin:0; background:#e1e1e1;">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" style="display:flex; min-height:100vh; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); align-items:center; justify-content:center; padding:24px;">
        <div style="background:white; border-radius:20px; padding:32px 28px; width:100%; max-width:400px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="text-align:center; margin-bottom:28px;">
                <div style="font-size:48px; margin-bottom:8px;">&#x1F4E6;</div>
                <h1 style="font-size:24px; font-weight:800; color:#1e293b; margin:0 0 4px;">InvenTrack Pro</h1>
                <div style="font-size:14px; color:#64748b;">Sign in to your account</div>
            </div>
            <div id="loginError" style="display:none; background:#fee2e2; border:1px solid #fecaca; color:#991b1b; padding:12px 14px; border-radius:8px; font-size:14px; margin-bottom:16px;"></div>
            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:16px; box-sizing:border-box; outline:none;">
            </div>
            <div style="margin-bottom:24px;">
                <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Password</label>
                <input type="password" id="loginPassword" placeholder="enter password" autocomplete="current-password" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:16px; box-sizing:border-box; outline:none;" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <button onclick="doLogin()" id="loginBtn" style="width:100%; padding:16px; border:none; border-radius:10px; font-size:18px; font-weight:700; cursor:pointer; background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white;">Sign In</button>
            <div style="text-align:center; margin-top:16px;">
                <a href="#" onclick="doPasswordReset(); return false;" style="font-size:13px; color:#64748b; text-decoration:none;">Forgot password?</a>
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button id="menuBtn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 16px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ò∞</button>
                <span style="font-size: 24px;">üì¶</span>
                <h1 style="font-size: 20px; margin: 0;">InvenTrack Pro</h1>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button id="btnRefresh" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; color: white; font-size: 18px; font-weight: 700;" title="Refresh from database">üîÑ</button>
                <div id="syncIndicator" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 12px; color: #86efac;">
                    <span>‚óè</span> <span id="syncText">Synced</span>
                </div>
            </div>
        </div>

        <div id="menuOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none;"></div>
        
        <div id="menuPanel" style="position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: white; z-index: 2001; transform: translateX(-100%); transition: transform 0.3s; overflow-y: auto; box-shadow: 2px 0 12px rgba(0,0,0,0.2);">
            <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 20px;">
                <div style="font-size: 20px; font-weight: 600; margin-bottom:12px;">üì¶ Navigation</div>
                <div style="background:rgba(255,255,255,0.15); border-radius:8px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div id="menuUserName" style="font-size:14px; font-weight:700;">Loading...</div>
                        <div id="menuUserRole" style="font-size:11px; opacity:0.8; margin-top:1px;"></div>
                    </div>
                    <button onclick="doSignOut()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer;">Sign Out</button>
                </div>
            </div>
            <div class="menu-item active" data-tab="dashboard" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üìä</span> Dashboard
            </div>
            <div class="menu-item" data-tab="tasks" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>‚úÖ</span> Tasks
            </div>

            <div style="padding: 8px 20px 4px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; background: #f8fafc; border-bottom: 1px solid #e0e0e0;">Inventory</div>

            <div class="menu-item" data-tab="inventory" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üìã</span> Inventory View
            </div>
            <div class="menu-item" data-tab="stock-entry" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>‚ûï</span> Stock Entry
            </div>
            <div class="menu-item" data-tab="add-edit" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>‚öôÔ∏è</span> Add / Edit Items
            </div>

            <div style="padding: 8px 20px 4px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; background: #f8fafc; border-bottom: 1px solid #e0e0e0;">Counting</div>

            <div class="menu-item" data-tab="physical-count" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üì±</span> Physical Count
            </div>
            <div class="menu-item" data-tab="scan-count" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>‚å®Ô∏è</span> Manual Count
            </div>
            <div class="menu-item" data-tab="shelf-audit" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üìã</span> Shelf Audit
            </div>
            <div class="menu-item" data-tab="count-reports" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üìä</span> Count Reports
            </div>
            <div class="menu-item" data-tab="qb-reconcile" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üîÑ</span> QB Reconcile
            </div>

            <div style="padding: 8px 20px 4px; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; background: #f8fafc; border-bottom: 1px solid #e0e0e0;">Ordering</div>

            <div class="menu-item" data-tab="po-review" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üì¶</span> PO Review
            </div>
            <div class="menu-item" data-tab="import-export" style="padding: 16px 20px; border-bottom: 1px solid #e0e0e0; cursor: pointer; font-size: 15px; font-weight: 500;">
                <span>üìÅ</span> Import / Export
            </div>
        </div>

        <div style="padding: 12px; max-width: 1200px; margin: 0 auto; overflow-x: hidden;">
            <div id="dashboard-tab" class="tab-content" style="display: block;">
                <div id="notification" style="padding: 14px; margin-bottom: 16px; border-radius: 8px; font-weight: 500; display: none;"></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 32px; margin-bottom: 8px;">üì¶</div>
                        <div id="statTotal" style="font-size: 32px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">0</div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 500;">Total Items</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                        <div id="statLowStock" style="font-size: 32px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">0</div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 500;">Low Stock</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚ùå</div>
                        <div id="statOutStock" style="font-size: 32px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">0</div>
                        <div style="font-size: 13px; color: #64748b; font-weight: 500;">Out of Stock</div>
                    </div>
                </div>
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <button id="btnAddItem" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white; margin-right: 8px;">‚ûï Add Item</button>
                    <button id="btnExport" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f59e0b; color: white;">üì§ Export</button>
                </div>
            </div>

            <div id="add-edit-tab" class="tab-content" style="display: none;">
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;">Item Information</h2>
                    <div style="margin-bottom: 16px; position: relative;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">SKU *</label>
                        <input type="text" id="sku" placeholder="Enter SKU" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; text-transform: uppercase;" autocomplete="off">
                        <div id="skuDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #3b82f6; border-radius: 8px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 4px;"></div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">Description</label>
                        <input type="text" id="description" placeholder="Item description" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">Qty on Hand</label>
                            <input type="number" id="qtyOnHand" placeholder="0" min="0" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">Min</label>
                            <input type="number" id="stockMin" placeholder="Min" min="0" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">Max</label>
                            <input type="number" id="stockMax" placeholder="Max" min="0" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 14px;">Location</label>
                        <input type="text" id="location" placeholder="e.g., A1-B2-C3" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; text-transform: uppercase;">
                    </div>
                    <button id="btnSave" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white; margin-right: 8px;">üíæ Save</button>
                    <button id="btnClear" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">üîÑ Clear</button>
                </div>
            </div>

            <div id="inventory-tab" class="tab-content" style="display: none;">
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                    <input type="text" id="searchBox" placeholder="üîç Search..." style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div id="itemCount" style="color: #64748b; font-size: 14px; font-weight: 600;">0 items</div>
                        <div id="massDeleteControls" style="display: none;">
                            <button id="btnDeleteSelected" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #ef4444; color: white;">üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)</button>
                        </div>
                    </div>
                </div>
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div id="inventoryTable"></div>
                </div>
            </div>

            <div id="physical-count-tab" class="tab-content" style="display: none;">
                <div id="countSession" style="display: none;">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">Session: <span id="sessionName"></span></div>
                                <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                    Progress: <span id="countProgress" style="font-weight: 600; color: #3b82f6;">0/0</span>
                                </div>
                            </div>
                            <button id="btnFinishCount" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">‚úì Finish</button>
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            Sorted by: <span id="sortMethod" style="font-weight: 600;"></span>
                        </div>
                    </div>
                    
                    <div id="currentItemCard" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 16px;">
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 4px;" id="countSKU"></div>
                            <div style="font-size: 16px; color: #64748b; margin-bottom: 8px;" id="countDescription"></div>
                            <div style="font-size: 14px; color: #94a3b8;">Location: <span id="countLocation" style="font-weight: 600; color: #1e40af;"></span></div>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #64748b; font-weight: 600;">SYSTEM QTY</div>
                            <div style="text-align: center; font-size: 32px; font-weight: 700; color: #64748b;" id="systemQty">0</div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 12px; font-size: 13px; color: #1e293b; font-weight: 600;">ACTUAL COUNT</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
                            <button id="btnMinus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚àí</button>
                            <input type="number" id="actualCount" value="0" min="0" readonly style="width: 120px; height: 70px; padding: 0; border: 3px solid #3b82f6; border-radius: 12px; font-size: 36px; font-weight: 700; text-align: center; cursor: pointer;">
                            <button id="btnPlus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #10b981; color: white;">+</button>
                        </div>
                        
                        <div id="varianceDisplay" style="text-align: center; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; display: none;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button id="btnSaveCount" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;">üíæ Save & Next</button>
                            <button id="btnSkipItem" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚è≠Ô∏è Skip</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button id="btnPrevItem" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #64748b;">‚Üê Previous</button>
                    </div>
                </div>
                
                <div id="startCountScreen">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">üì± Physical Count</h2>
                        <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
                            Start a new counting session. Walk down your aisle and count items in order. Your progress will be saved automatically.
                        </p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Session Name</label>
                            <input type="text" id="sessionNameInput" placeholder="e.g., Filter Shelf Count" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Sort Order</label>
                            <select id="countSortOrder" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                                <option value="location">By Location (A1, A2, A3...)</option>
                                <option value="sku">By SKU (P165789, P165800...)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Filter by Location (Optional)</label>
                            <input type="text" id="locationFilter" placeholder="e.g., A1 (leave empty for all)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; text-transform: uppercase;">
                            <small style="color: #64748b; font-size: 13px; display: block; margin-top: 6px;">
                                Filter by location prefix (e.g., "A1" for all items in A1-*)
                            </small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Filter by Brand (Optional)</label>
                            <input type="text" id="brandFilter" placeholder="e.g., V, MW, FD, GH (leave empty for all)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; text-transform: uppercase;">
                            <small style="color: #64748b; font-size: 13px; display: block; margin-top: 6px;">
                                Filter by brand prefix (e.g., "V" for all V86089635-type items)
                            </small>
                        </div>
                        
                        <button id="btnStartCount" style="padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white; width: 100%;">üöÄ Start Counting</button>
                    </div>
                </div>
            </div>

            <div id="scan-count-tab" class="tab-content" style="display: none;">
                <div id="scanCountSession" style="display: none;">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">üì∑ Scan Session</div>
                                <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                    Counted: <span id="scanProgress" style="font-weight: 600; color: #3b82f6;">0</span>
                                </div>
                            </div>
                            <button id="btnFinishScanCount" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">‚úì Finish</button>
                        </div>
                    </div>
                    
                    <div id="scanItemCard" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 16px;">
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 4px;" id="scanSKU"></div>
                            <div style="font-size: 16px; color: #64748b; margin-bottom: 8px;" id="scanDescription"></div>
                            <div style="font-size: 14px; color: #94a3b8;">Location: <span id="scanLocation" style="font-weight: 600; color: #1e40af;"></span></div>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #64748b; font-weight: 600;">SYSTEM QTY</div>
                            <div style="text-align: center; font-size: 32px; font-weight: 700; color: #64748b;" id="scanSystemQty">0</div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 12px; font-size: 13px; color: #1e293b; font-weight: 600;">ACTUAL COUNT</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
                            <button id="btnScanMinus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚àí</button>
                            <input type="number" id="scanActualCount" value="0" min="0" readonly style="width: 120px; height: 70px; padding: 0; border: 3px solid #3b82f6; border-radius: 12px; font-size: 36px; font-weight: 700; text-align: center; cursor: pointer;">
                            <button id="btnScanPlus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #10b981; color: white;">+</button>
                        </div>
                        
                        <div id="scanVarianceDisplay" style="text-align: center; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; display: none;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button id="btnSaveScanCount" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;">üíæ Save</button>
                            <button id="btnCancelScan" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚úï Cancel</button>
                        </div>
                    </div>
                    
                    <div id="scanCameraScreen" style="display: none;">
                        <!-- Camera scanning removed - goes directly to manual keyboard -->
                    </div>
                    
                    <div id="skuPickerScreen" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Select the correct SKU:</h3>
                            <div id="detectedSKUs"></div>
                            <button id="btnRescan" style="width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white; margin-top: 12px;">üì∑ Scan Again</button>
                        </div>
                    </div>
                    
                    <div id="manualSearchScreen" style="display: none;">
                        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 16px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Enter SKU:</h3>
                            
                            <input type="text" 
                                   id="manualSKUInput" 
                                   placeholder="Type SKU..." 
                                   inputmode="numeric"
                                   autocapitalize="characters"
                                   style="width: 100%; max-width: 100%; box-sizing: border-box; padding: 14px; border: 3px solid #3b82f6; border-radius: 10px; font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 12px; display: block;">
                            
                            <div id="quickMatchDropdown" style="max-height: 400px; overflow-y: auto; margin-bottom: 12px; display: none;"></div>
                            
                            <button id="btnCancelManual" style="width: 100%; box-sizing: border-box; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚úï Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div id="startScanCountScreen">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">‚å®Ô∏è Manual Count</h2>
                        <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
                            Type SKU numbers manually to count unsorted or random inventory items.
                        </p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Session Name</label>
                            <input type="text" id="scanSessionName" placeholder="e.g., Random Parts Count" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <button id="btnStartScanCount" style="padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white; width: 100%;">üöÄ Start Count</button>
                    </div>
                </div>
            </div>

            <div id="shelf-audit-tab" class="tab-content" style="display: none;">
                <div id="auditSession" style="display: none;">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">Shelf Audit</div>
                                <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                    Checked: <span id="auditProgress" style="font-weight: 600; color: #3b82f6;">0</span> | 
                                    <span style="color: #ef4444;">Return: <span id="auditReturnCount">0</span></span> | 
                                    <span style="color: #10b981;">Keep: <span id="auditKeepCount">0</span></span>
                                </div>
                            </div>
                            <button id="btnFinishAudit" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">‚úì Finish</button>
                        </div>
                    </div>
                    
                    <div id="auditItemCard" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 16px;">
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 4px;" id="auditSKU"></div>
                            <div style="font-size: 16px; color: #64748b; margin-bottom: 12px;" id="auditDescription"></div>
                            
                            <!-- Action Badge -->
                            <div id="auditActionBadge" style="padding: 12px 20px; border-radius: 12px; font-size: 18px; font-weight: 700; margin-bottom: 12px;"></div>
                            
                            <div style="font-size: 14px; color: #94a3b8;" id="auditInInventory"></div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 12px; font-size: 13px; color: #1e293b; font-weight: 600;">QUANTITY ON SHELF</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;">
                            <button id="btnAuditMinus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚àí</button>
                            <input type="number" id="auditQty" value="0" min="0" readonly style="width: 120px; height: 70px; padding: 0; border: 3px solid #3b82f6; border-radius: 12px; font-size: 36px; font-weight: 700; text-align: center; cursor: pointer;">
                            <button id="btnAuditPlus" style="width: 70px; height: 70px; border: none; border-radius: 12px; font-size: 32px; font-weight: 700; cursor: pointer; background: #10b981; color: white;">+</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button id="btnSaveAudit" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;">‚úì Confirm</button>
                            <button id="btnCancelAudit" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚úï Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Manual keyboard (reuse same structure) -->
                    <div id="auditKeyboardScreen">
                        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); height: 100vh; display: flex; flex-direction: column;">
                            <div style="flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 0;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Enter SKU:</h3>
                                
                                <div style="background: #f8fafc; border: 3px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 12px; min-height: 50px; font-size: 24px; font-weight: 700; text-align: center; color: #1e293b; word-break: break-all;" id="auditSkuDisplay">
                                    <span id="auditSkuTyped"></span><span style="opacity: 0.3;">|</span>
                                </div>
                                
                                <div id="auditQuickMatchDropdown" style="max-height: 250px; overflow-y: auto; margin-bottom: 12px; display: none;"></div>
                            </div>
                            
                            <div style="padding: 12px; background: white; border-top: 2px solid #e2e8f0;">
                                <div style="margin-bottom: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 4px;">
                                        <button onclick="addToAuditSKU('P')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">P</button>
                                        <button onclick="addToAuditSKU('M')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">M</button>
                                        <button onclick="addToAuditSKU('W')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">W</button>
                                        <button onclick="addToAuditSKU('G')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">G</button>
                                        <button onclick="addToAuditSKU('H')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">H</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;">
                                        <button onclick="addToAuditSKU('A')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">A</button>
                                        <button onclick="addToAuditSKU('B')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">B</button>
                                        <button onclick="addToAuditSKU('C')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">C</button>
                                        <button onclick="addToAuditSKU('D')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">D</button>
                                        <button onclick="addToAuditSKU('-')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">-</button>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px;">
                                    <button onclick="addToAuditSKU('1')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">1</button>
                                    <button onclick="addToAuditSKU('2')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">2</button>
                                    <button onclick="addToAuditSKU('3')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">3</button>
                                    <button onclick="addToAuditSKU('4')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">4</button>
                                    <button onclick="addToAuditSKU('5')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">5</button>
                                    <button onclick="addToAuditSKU('6')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">6</button>
                                    <button onclick="addToAuditSKU('7')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">7</button>
                                    <button onclick="addToAuditSKU('8')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">8</button>
                                    <button onclick="addToAuditSKU('9')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">9</button>
                                    <button onclick="backspaceAuditSKU()" style="padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚å´</button>
                                    <button onclick="addToAuditSKU('0')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">0</button>
                                    <button onclick="clearAuditSKU()" style="padding: 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: #f59e0b; color: white;">CLR</button>
                                </div>
                                
                                <button id="btnCancelAuditKeyboard" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚úï Cancel Session</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="startAuditScreen">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">üìã Shelf Audit</h2>
                        <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
                            Import a list of SKUs to return, then walk your shelf to audit. System will tell you KEEP or RETURN for each item.
                        </p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Session Name</label>
                            <input type="text" id="auditSessionName" placeholder="e.g., Filter Shelf Cleanup" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Import Return List (CSV or Paste)</label>
                            <div style="background: #dbeafe; padding: 14px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; color: #1e40af;">
                                <strong>Format:</strong> One SKU per line<br>
                                Example:<br>
                                <code>P165789<br>P165800<br>MW2018-7615-BSK</code>
                            </div>
                            <textarea id="auditReturnList" rows="8" placeholder="Paste SKU list here (one per line)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: monospace;"></textarea>
                        </div>
                        
                        <button id="btnStartAudit" style="padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white; width: 100%;">üöÄ Start Audit</button>
                    </div>
                </div>
            </div>

            <div id="po-review-tab" class="tab-content" style="display: none;">
                <div id="poReviewSession" style="display: none;">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">PO Review</div>
                                <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                    Reviewed: <span id="poReviewProgress" style="font-weight: 600; color: #3b82f6;">0</span> | 
                                    To Order: <span id="poReviewOrderCount" style="font-weight: 600; color: #10b981;">0</span>
                                </div>
                            </div>
                            <button id="btnFinishPOReview" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">‚úì Finish</button>
                        </div>
                    </div>
                    
                    <div id="poReviewItemCard" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 16px;">
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 4px;" id="poReviewSKU"></div>
                            <div style="font-size: 16px; color: #64748b; margin-bottom: 8px;" id="poReviewDescription"></div>
                            <div id="poReviewOrderBadge" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 700; display: inline-block; margin-bottom: 12px;"></div>
                        </div>
                        
                        <!-- Shelf Qty -->
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #64748b; font-weight: 600;">SHELF QUANTITY</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <button id="btnPOShelfMinus" style="width: 50px; height: 50px; border: none; border-radius: 8px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚àí</button>
                                <input type="number" id="poShelfQty" value="0" min="0" readonly style="width: 80px; height: 50px; padding: 0; border: 2px solid #3b82f6; border-radius: 8px; font-size: 24px; font-weight: 700; text-align: center; cursor: pointer;">
                                <button id="btnPOShelfPlus" style="width: 50px; height: 50px; border: none; border-radius: 8px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white;">+</button>
                            </div>
                        </div>
                        
                        <!-- Min/Max -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #64748b;">MIN STOCK</label>
                                <input type="number" id="poMinStock" placeholder="0" min="0" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 18px; font-weight: 600; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #64748b;">MAX STOCK</label>
                                <input type="number" id="poMaxStock" placeholder="0" min="0" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 18px; font-weight: 600; text-align: center;">
                            </div>
                        </div>
                        
                        <!-- Order Qty -->
                        <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #1e40af; font-weight: 600;">ADD TO ORDER</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <button id="btnPOOrderMinus" style="width: 50px; height: 50px; border: none; border-radius: 8px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚àí</button>
                                <input type="number" id="poOrderQty" value="0" min="0" readonly style="width: 80px; height: 50px; padding: 0; border: 2px solid #1e40af; border-radius: 8px; font-size: 24px; font-weight: 700; text-align: center; cursor: pointer;">
                                <button id="btnPOOrderPlus" style="width: 50px; height: 50px; border: none; border-radius: 8px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white;">+</button>
                            </div>
                        </div>
                        
                        <!-- Calculation Summary -->
                        <div id="poCalculation" style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: #64748b;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button id="btnSavePOReview" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;">‚úì Save & Next</button>
                            <button id="btnCancelPOReview" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">Skip</button>
                        </div>
                    </div>
                    
                    <!-- Keyboard for PO Review -->
                    <div id="poReviewKeyboardScreen">
                        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); height: 100vh; display: flex; flex-direction: column;">
                            <div style="flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 0;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Enter SKU:</h3>
                                
                                <div style="background: #f8fafc; border: 3px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 12px; min-height: 50px; font-size: 24px; font-weight: 700; text-align: center; color: #1e293b; word-break: break-all;" id="poReviewSkuDisplay">
                                    <span id="poReviewSkuTyped"></span><span style="opacity: 0.3;">|</span>
                                </div>
                                
                                <div id="poReviewQuickMatchDropdown" style="max-height: 250px; overflow-y: auto; margin-bottom: 12px; display: none;"></div>
                            </div>
                            
                            <div style="padding: 12px; background: white; border-top: 2px solid #e2e8f0;">
                                <div style="margin-bottom: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 4px;">
                                        <button onclick="addToPOReviewSKU('P')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">P</button>
                                        <button onclick="addToPOReviewSKU('M')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">M</button>
                                        <button onclick="addToPOReviewSKU('W')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">W</button>
                                        <button onclick="addToPOReviewSKU('G')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">G</button>
                                        <button onclick="addToPOReviewSKU('H')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #dbeafe; color: #1e40af;">H</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;">
                                        <button onclick="addToPOReviewSKU('F')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">F</button>
                                        <button onclick="addToPOReviewSKU('V')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">V</button>
                                        <button onclick="addToPOReviewSKU('D')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">D</button>
                                        <button onclick="addToPOReviewSKU('B')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">B</button>
                                        <button onclick="addToPOReviewSKU('-')" style="padding: 8px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; background: #f1f5f9; color: #64748b;">-</button>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px;">
                                    <button onclick="addToPOReviewSKU('1')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">1</button>
                                    <button onclick="addToPOReviewSKU('2')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">2</button>
                                    <button onclick="addToPOReviewSKU('3')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">3</button>
                                    <button onclick="addToPOReviewSKU('4')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">4</button>
                                    <button onclick="addToPOReviewSKU('5')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">5</button>
                                    <button onclick="addToPOReviewSKU('6')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">6</button>
                                    <button onclick="addToPOReviewSKU('7')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">7</button>
                                    <button onclick="addToPOReviewSKU('8')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">8</button>
                                    <button onclick="addToPOReviewSKU('9')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">9</button>
                                    <button onclick="backspacePOReviewSKU()" style="padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; background: #ef4444; color: white;">‚å´</button>
                                    <button onclick="addToPOReviewSKU('0')" style="padding: 12px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">0</button>
                                    <button onclick="clearPOReviewSKU()" style="padding: 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: #f59e0b; color: white;">CLR</button>
                                </div>
                                
                                <button id="btnCancelPOReviewKeyboard" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">‚úï Cancel Session</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="startPOReviewScreen">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">üì¶ PO Review</h2>
                        <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
                            Walk your shelf, check stock levels, set min/max, and add items to your purchase order. Avoid double-ordering by entering your current PO.
                        </p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Session Name</label>
                            <input type="text" id="poReviewSessionName" placeholder="e.g., MW Parts - Supplier ABC" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Brand Filter (Optional)</label>
                            <input type="text" id="poReviewBrandFilter" placeholder="e.g., MW, FD, GH, V (leave empty for all)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; text-transform: uppercase;">
                            <small style="color: #64748b; font-size: 13px; display: block; margin-top: 6px;">
                                Filter by brand prefix (letters before first number/dash)
                            </small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Current PO (Optional - CSV or Paste)</label>
                            <div style="background: #dbeafe; padding: 14px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; color: #1e40af;">
                                <strong>Format:</strong> SKU, Qty on Order<br>
                                Example:<br>
                                <code>MW2018-7615-BSK, 50<br>MW2019-1234-XYZ, 100</code>
                            </div>
                            <textarea id="poReviewCurrentPO" rows="6" placeholder="Paste current PO here (optional)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: monospace;"></textarea>
                        </div>
                        
                        <button id="btnStartPOReview" style="padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white; width: 100%;">üöÄ Start PO Review</button>
                    </div>
                </div>
            </div>

            <div id="count-reports-tab" class="tab-content" style="display: none;">
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Count Reports</h2>
                    <p style="color: #64748b; margin-bottom: 16px;">View and export your physical count sessions</p>
                    <div id="reportsCount" style="color: #64748b; font-size: 14px; font-weight: 600;">0 reports</div>
                </div>
                <div id="reportsList"></div>
            </div>

            <div id="stock-entry-tab" class="tab-content" style="display: none;">
                
                <!-- Progress counter -->
                <div style="background: #1e293b; color: white; padding: 14px 16px; border-radius: 12px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 15px; font-weight: 600;">üì¶ Stock Entry</div>
                    <div style="font-size: 14px;">Added this session: <span id="stockEntryCount" style="font-weight: 700; color: #86efac;">0</span></div>
                </div>

                <!-- Last saved confirmation -->
                <div id="stockEntryLastSaved" style="display: none; background: #d1fae5; border: 2px solid #10b981; padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; font-size: 14px; font-weight: 600; color: #065f46; text-align: center;"></div>

                <!-- Format Selector -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 16px; margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">SKU Format</label>
                    <select id="skuFormatSelector" onchange="switchSKUFormat(this.value)" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; background: white;">
                        <option value="manual">Manual Entry (any format)</option>
                        <option value="GH">GH ‚Äî Gates Crimp Fittings</option>
                        <option value="GHA">GHA ‚Äî Gates Adapter Fittings</option>
                        <option value="MH">MH ‚Äî McHale</option>
                        <option value="MW">MW ‚Äî Martin Welding</option>
                        <option value="FDP">FDP ‚Äî Donaldson</option>
                    </select>
                </div>

                <!-- Manual Entry Form (default) -->
                <div id="manualEntryForm" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px;">
                    
                    <!-- SKU -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">SKU *</label>
                        <input type="text" 
                               id="entrySKU" 
                               placeholder="e.g. V86089635"
                               autocapitalize="characters"
                               autocorrect="off"
                               inputmode="numeric"
                               oninput="this.value=this.value.toUpperCase(); checkExistingSKU(this.value);"
                               style="width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-transform: uppercase;">
                        <div id="entrySkuWarning" style="display: none; color: #ef4444; font-size: 13px; margin-top: 6px; font-weight: 600;">‚ö†Ô∏è SKU already exists - saving will update it</div>
                    </div>

                    <!-- QOH -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Qty on Hand *</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustEntryQty('qoh', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="entryQOH" value="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustEntryQty('qoh', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- MIN -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Min Stock</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustEntryQty('min', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="entryMIN" value="" placeholder="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustEntryQty('min', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- MAX -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Max Stock</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustEntryQty('max', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="entryMAX" value="" placeholder="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustEntryQty('max', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- Location -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Location</label>
                        <input type="text" 
                               id="entryLocation" 
                               placeholder="e.g. A1-B2-C3"
                               autocapitalize="characters"
                               autocorrect="off"
                               oninput="this.value=this.value.toUpperCase();"
                               style="width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 18px; font-weight: 600; text-transform: uppercase;">
                    </div>

                    <!-- Save button -->
                    <button id="btnSaveEntry" onclick="saveStockEntry()" style="width: 100%; padding: 20px; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; background: #10b981; color: white; touch-action: manipulation;">
                        ‚úì Save &amp; New
                    </button>
                </div>

                <!-- GH Format Entry Form (hidden by default) -->
                <div id="ghEntryForm" style="display: none; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px;">
                    
                    <!-- First and Second Numbers (side by side) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">First # *</label>
                            <input type="text" 
                                   id="ghFirstNum" 
                                   placeholder="4"
                                   inputmode="numeric"
                                   oninput="updateGHPreview(); checkGHExists();"
                                   style="width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Second # *</label>
                            <input type="text" 
                                   id="ghSecondNum" 
                                   placeholder="4"
                                   inputmode="numeric"
                                   oninput="updateGHPreview(); checkGHExists();"
                                   style="width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center;">
                        </div>
                    </div>
                    
                    <div id="ghSkuWarning" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; font-weight: 600; text-align: center;">‚ö†Ô∏è SKU exists - saving will update it</div>

                    <!-- Suffix Selector -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Suffix</label>
                        <select id="ghSuffix" onchange="updateGHPreview(); checkGHExists();" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 700; background: white;">
                            <optgroup label="F - Female">
                                <option value="FBSPORX">FBSPORX</option>
                                <option value="FBSPORX45">FBSPORX45</option>
                                <option value="FBSPORX90">FBSPORX90</option>
                                <option value="FDHORX90">FDHORX90</option>
                                <option value="FDLORX">FDLORX</option>
                                <option value="FDLORX45">FDLORX45</option>
                                <option value="FDLORX90">FDLORX90</option>
                                <option value="FFORX">FFORX</option>
                                <option value="FFORX45">FFORX45</option>
                                <option value="FFORX90">FFORX90</option>
                                <option value="FJX">FJX</option>
                                <option value="FJX45">FJX45</option>
                                <option value="FJX90">FJX90</option>
                                <option value="FPX">FPX</option>
                            </optgroup>
                            <optgroup label="M - Male">
                                <option value="MB">MB</option>
                                <option value="MBSPP">MBSPP</option>
                                <option value="MBX90">MBX90</option>
                                <option value="MBX90BL">MBX90BL</option>
                                <option value="MDH">MDH</option>
                                <option value="MDL">MDL</option>
                                <option value="MFFOR">MFFOR</option>
                                <option value="MJ">MJ</option>
                                <option value="MP">MP</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Format Preview (moved here) -->
                    <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 14px; border-radius: 10px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; color: #1e40af; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Preview</div>
                        <div id="ghSKUPreview" style="font-size: 24px; font-weight: 700; color: #1e293b; font-family: monospace;">GH__G-__MB</div>
                    </div>

                    <!-- QOH -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Qty on Hand *</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustGHQty('qoh', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="ghQOH" value="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustGHQty('qoh', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- MIN -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Min Stock</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustGHQty('min', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="ghMIN" value="" placeholder="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustGHQty('min', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- MAX -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Max Stock</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="adjustGHQty('max', -1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                            <input type="number" id="ghMAX" value="" placeholder="0" min="0" inputmode="numeric"
                                   style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 20px; font-weight: 700; text-align: center; min-width: 0;">
                            <button onclick="adjustGHQty('max', 1)" style="width: 48px; height: 48px; border: none; border-radius: 10px; font-size: 24px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                        </div>
                    </div>

                    <!-- Location -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Location</label>
                        <input type="text" 
                               id="ghLocation" 
                               placeholder="e.g. A1-B2-C3"
                               autocapitalize="characters"
                               autocorrect="off"
                               oninput="this.value=this.value.toUpperCase();"
                               style="width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 18px; font-weight: 600; text-transform: uppercase;">
                    </div>

                    <!-- Save button -->
                    <button id="btnSaveGH" onclick="saveGHEntry()" style="width: 100%; padding: 20px; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; background: #10b981; color: white; touch-action: manipulation;">
                        ‚úì Save &amp; New
                    </button>
                </div>


                <!-- GHA ‚Äî Gates Adapter Fittings -->
                <div id="ghaEntryForm" style="display:none; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px;">
                    <div style="background:#fef9c3; border:2px solid #fde047; padding:10px 14px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#713f12; font-weight:600;">
                        Format: GHA{4}-{2}-{2} &nbsp;e.g. GHA1503-06-06
                    </div>
                    <div id="ghaSkuWarning" style="display:none; color:#ef4444; font-size:13px; margin-bottom:12px; font-weight:600;">‚ö†Ô∏è SKU already exists ‚Äî saving will update it</div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Type all 8 digits (auto-formats) *</label>
                        <input type="text" id="ghaRawInput" placeholder="15030606" inputmode="numeric"
                               oninput="ghaAutoFormat(this); ghaCheckExistsDebounced();"
                               style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:22px; font-weight:700; box-sizing:border-box; letter-spacing:2px;">
                        <div style="font-size:12px; color:#94a3b8; margin-top:6px;">Dashes insert automatically after digits 4 and 6.</div>
                    </div>

                    <!-- Preview -->
                    <div style="background:#dbeafe; border:2px solid #3b82f6; padding:14px; border-radius:10px; margin-bottom:16px; text-align:center;">
                        <div style="font-size:11px; font-weight:700; color:#1e40af; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">Preview</div>
                        <div id="ghaSKUPreview" style="font-size:24px; font-weight:700; color:#1e293b; font-family:monospace;">GHA-____-__-__</div>
                    </div>

                    <!-- QOH / Min / Max / Location -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Qty on Hand *</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="adjustWizardQty('ghaQOH',-1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#ef4444;color:white;flex-shrink:0;touch-action:manipulation;">‚àí</button>
                            <input type="number" id="ghaQOH" value="0" min="0" inputmode="numeric" style="flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:20px;font-weight:700;text-align:center;min-width:0;">
                            <button onclick="adjustWizardQty('ghaQOH',1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#10b981;color:white;flex-shrink:0;touch-action:manipulation;">+</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Min</label>
                            <input type="number" id="ghaMIN" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Max</label>
                            <input type="number" id="ghaMAX" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                    </div>
                    <div style="margin-bottom:24px;">
                        <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Location</label>
                        <input type="text" id="ghaLocation" placeholder="e.g. A1-B2-C3" autocapitalize="characters" autocorrect="off" oninput="this.value=this.value.toUpperCase();" style="width:100%;box-sizing:border-box;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;font-weight:600;text-transform:uppercase;">
                    </div>
                    <button onclick="saveGHAEntry()" style="width:100%;padding:20px;border:none;border-radius:12px;font-size:20px;font-weight:700;cursor:pointer;background:#10b981;color:white;touch-action:manipulation;">‚úì Save &amp; New</button>
                </div>

                <!-- MH ‚Äî McHale -->
                <div id="mhEntryForm" style="display:none; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px;">
                    <div style="background:#fef9c3; border:2px solid #fde047; padding:10px 14px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#713f12; font-weight:600;">
                        Format: MH-{3 letters}{5 numbers} &nbsp;e.g. MH-CPL00043
                    </div>
                    <div id="mhSkuWarning" style="display:none; color:#ef4444; font-size:13px; margin-bottom:12px; font-weight:600;">‚ö†Ô∏è SKU already exists ‚Äî saving will update it</div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div>
                            <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">3 Letters *</label>
                            <input type="text" id="mhLetters" placeholder="CPL" maxlength="3"
                                   autocapitalize="characters" autocorrect="off"
                                   oninput="this.value=this.value.replace(/[^a-zA-Z]/g,'').toUpperCase().slice(0,3); mhUpdatePreview(); mhCheckExistsDebounced();"
                                   style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:22px; font-weight:700; text-align:center; box-sizing:border-box; text-transform:uppercase; letter-spacing:3px;">
                        </div>
                        <div>
                            <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">5 Numbers *</label>
                            <input type="text" id="mhNumbers" placeholder="00043" maxlength="5" inputmode="numeric"
                                   oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,5); mhUpdatePreview(); mhCheckExistsDebounced();"
                                   style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:22px; font-weight:700; text-align:center; box-sizing:border-box; letter-spacing:2px;">
                        </div>
                    </div>

                    <!-- Preview -->
                    <div style="background:#dbeafe; border:2px solid #3b82f6; padding:14px; border-radius:10px; margin-bottom:16px; text-align:center;">
                        <div style="font-size:11px; font-weight:700; color:#1e40af; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">Preview</div>
                        <div id="mhSKUPreview" style="font-size:24px; font-weight:700; color:#1e293b; font-family:monospace;">MH-___00000</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Qty on Hand *</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="adjustWizardQty('mhQOH',-1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#ef4444;color:white;flex-shrink:0;touch-action:manipulation;">‚àí</button>
                            <input type="number" id="mhQOH" value="0" min="0" inputmode="numeric" style="flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:20px;font-weight:700;text-align:center;min-width:0;">
                            <button onclick="adjustWizardQty('mhQOH',1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#10b981;color:white;flex-shrink:0;touch-action:manipulation;">+</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Min</label>
                            <input type="number" id="mhMIN" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Max</label>
                            <input type="number" id="mhMAX" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                    </div>
                    <div style="margin-bottom:24px;">
                        <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Location</label>
                        <input type="text" id="mhLocation" placeholder="e.g. A1-B2-C3" autocapitalize="characters" autocorrect="off" oninput="this.value=this.value.toUpperCase();" style="width:100%;box-sizing:border-box;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;font-weight:600;text-transform:uppercase;">
                    </div>
                    <button onclick="saveMHEntry()" style="width:100%;padding:20px;border:none;border-radius:12px;font-size:20px;font-weight:700;cursor:pointer;background:#10b981;color:white;touch-action:manipulation;">‚úì Save &amp; New</button>
                </div>

                <!-- MW ‚Äî Martin Welding -->
                <div id="mwEntryForm" style="display:none; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px;">
                    <div style="background:#fef9c3; border:2px solid #fde047; padding:10px 14px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#713f12; font-weight:600;">
                        Format: MW{4}-{4}-{3+} &nbsp;e.g. MW2018-7615-158BSK
                    </div>
                    <div id="mwSkuWarning" style="display:none; color:#ef4444; font-size:13px; margin-bottom:12px; font-weight:600;">‚ö†Ô∏è SKU already exists ‚Äî saving will update it</div>

                    <!-- Single auto-format input -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Type numbers (auto-formats) *</label>
                        <input type="text" id="mwRawInput" placeholder="2018761515800BSK" inputmode="numeric"
                               autocapitalize="characters" autocorrect="off"
                               oninput="mwAutoFormat(this); mwCheckExistsDebounced();"
                               style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:10px; font-size:18px; font-weight:700; box-sizing:border-box; text-transform:uppercase; letter-spacing:1px;">
                        <div style="font-size:12px; color:#94a3b8; margin-top:6px;">Type digits ‚Äî dashes insert automatically. Switch to QWERTY for letters at the end.</div>
                    </div>

                    <!-- Preview -->
                    <div style="background:#dbeafe; border:2px solid #3b82f6; padding:14px; border-radius:10px; margin-bottom:16px; text-align:center;">
                        <div style="font-size:11px; font-weight:700; color:#1e40af; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">Preview</div>
                        <div id="mwSKUPreview" style="font-size:22px; font-weight:700; color:#1e293b; font-family:monospace;">MW____-____-___</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Qty on Hand *</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="adjustWizardQty('mwQOH',-1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#ef4444;color:white;flex-shrink:0;touch-action:manipulation;">‚àí</button>
                            <input type="number" id="mwQOH" value="0" min="0" inputmode="numeric" style="flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:20px;font-weight:700;text-align:center;min-width:0;">
                            <button onclick="adjustWizardQty('mwQOH',1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#10b981;color:white;flex-shrink:0;touch-action:manipulation;">+</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Min</label>
                            <input type="number" id="mwMIN" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Max</label>
                            <input type="number" id="mwMAX" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                    </div>
                    <div style="margin-bottom:24px;">
                        <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Location</label>
                        <input type="text" id="mwLocation" placeholder="e.g. A1-B2-C3" autocapitalize="characters" autocorrect="off" oninput="this.value=this.value.toUpperCase();" style="width:100%;box-sizing:border-box;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;font-weight:600;text-transform:uppercase;">
                    </div>
                    <button onclick="saveMWEntry()" style="width:100%;padding:20px;border:none;border-radius:12px;font-size:20px;font-weight:700;cursor:pointer;background:#10b981;color:white;touch-action:manipulation;">‚úì Save &amp; New</button>
                </div>

                <!-- FDP ‚Äî Donaldson -->
                <div id="fdpEntryForm" style="display:none; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:20px;">
                    <div style="background:#fef9c3; border:2px solid #fde047; padding:10px 14px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#713f12; font-weight:600;">
                        Format: FDP{numbers} &nbsp;e.g. FDP550325
                    </div>
                    <div id="fdpSkuWarning" style="display:none; color:#ef4444; font-size:13px; margin-bottom:12px; font-weight:600;">‚ö†Ô∏è SKU already exists ‚Äî saving will update it</div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Part Numbers *</label>
                        <input type="text" id="fdpNumbers" placeholder="550325" inputmode="numeric"
                               oninput="this.value=this.value.replace(/[^0-9]/g,''); fdpUpdatePreview(); fdpCheckExistsDebounced();"
                               style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:10px; font-size:22px; font-weight:700; text-align:center; box-sizing:border-box; letter-spacing:2px;">
                    </div>

                    <!-- Preview -->
                    <div style="background:#dbeafe; border:2px solid #3b82f6; padding:14px; border-radius:10px; margin-bottom:16px; text-align:center;">
                        <div style="font-size:11px; font-weight:700; color:#1e40af; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">Preview</div>
                        <div id="fdpSKUPreview" style="font-size:24px; font-weight:700; color:#1e293b; font-family:monospace;">FDP______</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Qty on Hand *</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="adjustWizardQty('fdpQOH',-1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#ef4444;color:white;flex-shrink:0;touch-action:manipulation;">‚àí</button>
                            <input type="number" id="fdpQOH" value="0" min="0" inputmode="numeric" style="flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:20px;font-weight:700;text-align:center;min-width:0;">
                            <button onclick="adjustWizardQty('fdpQOH',1)" style="width:48px;height:48px;border:none;border-radius:10px;font-size:24px;font-weight:700;cursor:pointer;background:#10b981;color:white;flex-shrink:0;touch-action:manipulation;">+</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Min</label>
                            <input type="number" id="fdpMIN" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Max</label>
                            <input type="number" id="fdpMAX" placeholder="0" min="0" inputmode="numeric" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:18px;font-weight:700;text-align:center;box-sizing:border-box;">
                        </div>
                    </div>
                    <div style="margin-bottom:24px;">
                        <label style="display:block;font-size:13px;font-weight:700;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Location</label>
                        <input type="text" id="fdpLocation" placeholder="e.g. A1-B2-C3" autocapitalize="characters" autocorrect="off" oninput="this.value=this.value.toUpperCase();" style="width:100%;box-sizing:border-box;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;font-weight:600;text-transform:uppercase;">
                    </div>
                    <button onclick="saveFDPEntry()" style="width:100%;padding:20px;border:none;border-radius:12px;font-size:20px;font-weight:700;cursor:pointer;background:#10b981;color:white;touch-action:manipulation;">‚úì Save &amp; New</button>
                </div>

            </div>
            <div id="import-export-tab" class="tab-content" style="display: none;">
                <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Import/Export</h2>
                    <div style="background: #dbeafe; padding: 14px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #1e40af;">
                        <strong>CSV Format:</strong> SKU, Description, Qty, Min, Max, Location
                    </div>
                    <button id="btnImport" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white; margin-right: 8px;">üì• Import CSV</button>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <button id="btnExport2" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f59e0b; color: white;">üì§ Export</button>
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Paste CSV Data:</label>
                        <textarea id="csvPaste" rows="8" placeholder="Paste here..." style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;"></textarea>
                        <button id="btnImportPaste" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white; margin-top: 8px; width: 100%;">Import Pasted Data</button>
                    </div>
                </div>
            </div>
            <!-- QB RECONCILE TAB -->
            <div id="qb-reconcile-tab" class="tab-content" style="display: none;">

                <!-- UPLOAD SCREEN (shown when no active session) -->
                <div id="qbUploadScreen">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">üîÑ QB Reconcile</h2>
                        <p style="color: #64748b; margin-bottom: 20px; font-size: 14px; line-height: 1.6;">
                            Upload your QuickBooks export on any device. Then walk the warehouse and verify each part from any device ‚Äî quantities sync live through the cloud.
                        </p>

                        <!-- Active sessions list -->
                        <div id="qbActiveSessionsArea" style="margin-bottom: 20px; display: none;">
                            <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 10px; color: #1e293b;">üìã Active Sessions</h3>
                            <div id="qbActiveSessionsList"></div>
                        </div>

                        <div style="background: #fef9c3; border: 2px solid #fde047; padding: 14px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #713f12;">
                            <strong>üìÑ CSV Format:</strong> Just two columns ‚Äî SKU and Quantity:<br>
                            <code style="display: block; margin-top: 6px; background: #fff; padding: 6px 10px; border-radius: 4px; font-size: 12px;">SKU, Qty</code>
                            Example: <code>GH4G-4MB, 12</code><br>
                            <span style="font-size: 12px; opacity: 0.8;">Description will be pulled automatically from InvenTrack.</span>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Session Name</label>
                            <input type="text" id="qbSessionName" placeholder="e.g., QB Reconcile Feb 2026" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Upload QuickBooks CSV</label>
                            <button onclick="document.getElementById('qbCSVFile').click()" style="width: 100%; padding: 14px; border: 2px dashed #cbd5e1; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f8fafc; color: #475569;">üìÇ Choose CSV File</button>
                            <input type="file" id="qbCSVFile" accept=".csv" style="display: none;" onchange="qbHandleFileUpload(event)">
                            <div id="qbFileStatus" style="margin-top: 8px; font-size: 13px; color: #64748b; display: none;"></div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">‚Äî or Paste CSV Data ‚Äî</label>
                            <textarea id="qbCSVPaste" rows="6" placeholder="SKU,Qty&#10;GH4G-4MB,12&#10;P165789,50&#10;MW2018-7615-BSK,8" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: monospace; box-sizing: border-box;"></textarea>
                        </div>

                        <button onclick="qbStartSession()" style="width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background: #f59e0b; color: white;">üöÄ Upload & Start Session</button>
                    </div>
                </div>

                <!-- RECONCILE SESSION SCREEN -->
                <div id="qbSessionScreen" style="display: none;">

                    <!-- Header bar -->
                    <div style="background: white; padding: 14px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 700;" id="qbActiveSessionName">QB Reconcile</div>
                                <div style="font-size: 13px; color: #64748b; margin-top: 2px;">
                                    Verified: <span id="qbVerifiedCount" style="font-weight: 700; color: #10b981;">0</span> / <span id="qbTotalCount" style="font-weight: 700;">0</span>
                                    &nbsp;|&nbsp; ‚ö†Ô∏è <span id="qbDiscrepancyCount" style="font-weight: 700; color: #ef4444;">0</span> discrepancies
                                </div>
                            </div>
                            <button onclick="qbFinishSession()" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">‚úì Finish</button>
                        </div>
                        <!-- Progress bar -->
                        <div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
                            <div id="qbProgressBar" style="height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 4px; transition: width 0.3s; width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Filter/Search bar -->
                    <div style="background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <input type="text" id="qbSearchBox" placeholder="üîç Search SKU or description..." oninput="qbRenderList()" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="qbSetFilter('all')" id="qbFilterAll" style="flex: 1; padding: 8px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white; min-width: 70px;">All</button>
                            <button onclick="qbSetFilter('pending')" id="qbFilterPending" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: white; color: #64748b; min-width: 70px;">Pending</button>
                            <button onclick="qbSetFilter('ok')" id="qbFilterOk" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: white; color: #64748b; min-width: 70px;">‚úì Match</button>
                            <button onclick="qbSetFilter('diff')" id="qbFilterDiff" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: white; color: #64748b; min-width: 70px;">‚ö†Ô∏è Diff</button>
                        </div>
                    </div>

                    <!-- Item list -->
                    <div id="qbItemList"></div>

                </div>

                <!-- ITEM VERIFY CARD (modal-style overlay) -->
                <div id="qbVerifyCard" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 16px;">
                    <div style="background: white; border-radius: 16px; padding: 24px; width: 100%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 26px; font-weight: 800; color: #1e293b; margin-bottom: 4px;" id="qbVerifySKU"></div>
                            <div style="font-size: 15px; color: #64748b; margin-bottom: 10px;" id="qbVerifyDesc"></div>
                            <div id="qbVerifyLocationBadge" style="display: inline-block; padding: 4px 12px; background: #e0f2fe; border-radius: 20px; font-size: 12px; font-weight: 600; color: #0369a1;"></div>
                        </div>

                        <!-- Three columns: QB Qty | InvenTrack Qty | Variance -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background: #fef9c3; padding: 14px 10px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 11px; font-weight: 700; color: #713f12; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">QuickBooks</div>
                                <div style="font-size: 28px; font-weight: 800; color: #713f12;" id="qbVerifyQBQty">-</div>
                            </div>
                            <div style="background: #dbeafe; padding: 14px 10px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 11px; font-weight: 700; color: #1e40af; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">InvenTrack</div>
                                <div style="font-size: 28px; font-weight: 800; color: #1e40af;" id="qbVerifyITQty">-</div>
                            </div>
                            <div id="qbVerifyVarianceBox" style="padding: 14px 10px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;" id="qbVerifyVarianceLabel">Variance</div>
                                <div style="font-size: 28px; font-weight: 800;" id="qbVerifyVarianceVal">-</div>
                            </div>
                        </div>

                        <!-- Actual count entry -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Your Physical Count</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button onclick="qbAdjustCount(-1)" style="width: 56px; height: 56px; border: none; border-radius: 10px; font-size: 28px; font-weight: 700; cursor: pointer; background: #ef4444; color: white; flex-shrink: 0; touch-action: manipulation;">‚àí</button>
                                <input type="number" id="qbActualCount" value="0" min="0" inputmode="numeric" style="width: 80px; flex-shrink: 0; height: 56px; padding: 0; border: 3px solid #3b82f6; border-radius: 10px; font-size: 26px; font-weight: 800; text-align: center; box-sizing: border-box;" onclick="this.select()">
                                <button onclick="qbAdjustCount(1)" style="width: 56px; height: 56px; border: none; border-radius: 10px; font-size: 28px; font-weight: 700; cursor: pointer; background: #10b981; color: white; flex-shrink: 0; touch-action: manipulation;">+</button>
                            </div>
                        </div>

                        <!-- Notes field -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Notes (optional)</label>
                            <input type="text" id="qbVerifyNotes" placeholder="e.g. found in wrong location" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button onclick="qbCancelVerify()" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; background: white; color: #64748b;">‚úï Cancel</button>
                            <button onclick="qbSaveVerify()" style="padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">‚úì Save</button>
                        </div>
                    </div>
                </div>

                <!-- RESULTS SCREEN -->
                <div id="qbResultsScreen" style="display: none;">
                    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 4px;" id="qbResultsTitle">Reconcile Complete</h2>
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 20px;" id="qbResultsDate"></div>
                        <div id="qbResultsSummary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;"></div>
                        <div id="qbResultsDetail"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                            <button onclick="qbExportResults()" style="padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white;">üì• Export CSV</button>
                            <button onclick="qbNewSession()" style="padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; background: #64748b; color: white;">üîÑ New Session</button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- END QB RECONCILE TAB -->

            <!-- TASKS TAB -->
            <div id="tasks-tab" class="tab-content" style="display:none;">

                <!-- Task list view -->
                <div id="tasksListScreen">
                    <!-- Filter bar -->
                    <div style="background:white; padding:12px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:14px;">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <button onclick="tasksSetFilter('all')" id="tfAll" style="flex:1; padding:8px 4px; border:2px solid #3b82f6; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; background:#3b82f6; color:white; min-width:60px;">All</button>
                            <button onclick="tasksSetFilter('not_started')" id="tfNot" style="flex:1; padding:8px 4px; border:2px solid #e2e8f0; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; background:white; color:#64748b; min-width:60px;">Not Started</button>
                            <button onclick="tasksSetFilter('in_progress')" id="tfIn" style="flex:1; padding:8px 4px; border:2px solid #e2e8f0; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; background:white; color:#64748b; min-width:60px;">In Progress</button>
                            <button onclick="tasksSetFilter('needs_review')" id="tfRev" style="flex:1; padding:8px 4px; border:2px solid #e2e8f0; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; background:white; color:#64748b; min-width:60px;">Review</button>
                            <button onclick="tasksSetFilter('completed')" id="tfDone" style="flex:1; padding:8px 4px; border:2px solid #e2e8f0; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; background:white; color:#64748b; min-width:60px;">Done</button>
                        </div>
                    </div>

                    <!-- Manager-only: Add task button -->
                    <div id="tasksManagerBar" style="display:none; margin-bottom:14px;">
                        <button onclick="tasksOpenCreate()" style="width:100%; padding:14px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; background:#3b82f6; color:white;">+ New Task</button>
                    </div>

                    <!-- Task list -->
                    <div id="tasksList"></div>
                </div>

                <!-- Create / Edit task screen (manager only) -->
                <div id="tasksFormScreen" style="display:none;">
                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                        <h2 id="tasksFormTitle" style="font-size:18px; font-weight:700; margin-bottom:20px; color:#1e293b;">New Task</h2>

                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Task Title *</label>
                            <input type="text" id="taskTitle" placeholder="e.g. Count GH fittings on shelf B3" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:16px; box-sizing:border-box;">
                        </div>

                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Instructions / Notes</label>
                            <textarea id="taskNotes" rows="4" placeholder="Describe exactly what needs to be done..." style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:15px; box-sizing:border-box; font-family:inherit; resize:vertical;"></textarea>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Priority</label>
                                <select id="taskPriority" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:15px; box-sizing:border-box; background:white;">
                                    <option value="low">üü¢ Low</option>
                                    <option value="medium" selected>üü° Medium</option>
                                    <option value="high">üî¥ High</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Brand Prefix</label>
                                <input type="text" id="taskBrandPrefix" placeholder="e.g. GH, MW, FD" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:15px; box-sizing:border-box; text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
                            </div>
                        </div>

                        <div id="taskBrandInfo" style="display:none; background:#dbeafe; padding:10px 14px; border-radius:8px; margin-bottom:16px; font-size:13px; color:#1e40af;"></div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                            <button onclick="tasksCloseForm()" style="padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; background:white; color:#64748b;">Cancel</button>
                            <button onclick="tasksSave()" style="padding:14px; border:none; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; background:#3b82f6; color:white;">Save Task</button>
                        </div>
                    </div>
                </div>

                <!-- Task detail / status update screen -->
                <div id="tasksDetailScreen" style="display:none;">
                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:14px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
                            <button onclick="tasksCloseDetail()" style="background:#f1f5f9; border:none; padding:8px 14px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; color:#64748b;">‚Üê Back</button>
                            <div id="tasksDetailManagerBtns" style="display:none; gap:8px; display:none;">
                                <button onclick="tasksEditCurrent()" style="background:#f1f5f9; border:none; padding:8px 14px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; color:#64748b;">‚úèÔ∏è Edit</button>
                                <button onclick="tasksDeleteCurrent()" style="background:#fee2e2; border:none; padding:8px 14px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; color:#991b1b;">üóëÔ∏è Delete</button>
                            </div>
                        </div>

                        <div id="tasksDetailPriorityBadge" style="display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; margin-bottom:10px;"></div>
                        <h2 id="tasksDetailTitle" style="font-size:20px; font-weight:800; color:#1e293b; margin:0 0 10px;"></h2>
                        <div id="tasksDetailBrandBadge" style="display:none; margin-bottom:10px;"></div>
                        <div id="tasksDetailNotes" style="font-size:15px; color:#475569; line-height:1.6; white-space:pre-wrap; background:#f8fafc; padding:14px; border-radius:8px; margin-bottom:20px;"></div>

                        <!-- Status buttons -->
                        <div style="margin-bottom:8px;">
                            <div style="font-size:13px; font-weight:700; color:#64748b; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px;">Update Status</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <button onclick="tasksSetStatus('not_started')" id="tsBtnNotStarted" style="padding:14px 8px; border:2px solid #e2e8f0; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; background:white; color:#64748b;">‚¨ú Not Started</button>
                                <button onclick="tasksSetStatus('in_progress')" id="tsBtnInProgress" style="padding:14px 8px; border:2px solid #e2e8f0; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; background:white; color:#64748b;">üîµ In Progress</button>
                                <button onclick="tasksSetStatus('needs_review')" id="tsBtnNeedsReview" style="padding:14px 8px; border:2px solid #e2e8f0; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; background:white; color:#64748b;">üü° Needs Review</button>
                                <button id="tsBtnCompleted" style="padding:14px 8px; border:2px solid #e2e8f0; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; background:white; color:#94a3b8;">‚úÖ Completed</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- END TASKS TAB -->

        </div>
    </div>

    <div id="loading" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999;">
        <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
            <div style="border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
            <div id="loadingText">Loading...</div>
        </div>
    </div>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f8fafc; }
        .menu-item:hover { background: #f5f5f5; }
        .menu-item.active { background: #e0f2fe; color: #0369a1; border-left: 4px solid #0369a1; }
    </style>

    <script>
        const SUPABASE_URL = 'https://hlabmpfycagxdhmpiqba.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsYWJtcGZ5Y2FneGRobXBpcWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzM2MjgsImV4cCI6MjA4NjQwOTYyOH0.6JbELfSPiyb_h9F-s4KiN8WxOv6b5rdU36gUd1kC04U';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let inventory = [];
        let selectedItems = new Set();
        let countSessions = [];
        let currentSession = null;
        let currentItemIndex = 0;
        let countedItems = [];
        let scanCountSession = null;
        let scanCountedItems = [];
        let auditSession = null;
        let auditedItems = [];
        let auditReturnList = [];
        let currentAuditSKUInput = '';
        let poReviewSession = null;
        let poReviewedItems = [];
        let currentPOList = {};
        let currentPOReviewSKUInput = '';

        // SKU Autocomplete
        document.getElementById('sku').addEventListener('input', function(e) {
            const value = e.target.value.toUpperCase();
            const dropdown = document.getElementById('skuDropdown');
            
            if (value.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = inventory.filter(item => 
                item.sku.toUpperCase().includes(value)
            ).slice(0, 10);
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            let html = '';
            matches.forEach(item => {
                html += '<div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9;" onmouseover="this.style.background=\'#f8fafc\'" onmouseout="this.style.background=\'white\'" onclick="selectSKU(\'' + item.sku + '\')">';
                html += '<div style="font-weight: 600; color: #1e293b;">' + item.sku + '</div>';
                if (item.description) {
                    html += '<div style="font-size: 13px; color: #64748b;">' + item.description + '</div>';
                }
                html += '<div style="font-size: 12px; color: #94a3b8; margin-top: 2px;">QOH: ' + (item.qtyOnHand || 0) + ' | Loc: ' + (item.location || '-') + '</div>';
                html += '</div>';
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#sku') && !e.target.closest('#skuDropdown')) {
                document.getElementById('skuDropdown').style.display = 'none';
            }
        });
        
        function selectSKU(sku) {
            const item = inventory.find(i => i.sku === sku);
            if (!item) return;
            
            document.getElementById('sku').value = item.sku;
            document.getElementById('description').value = item.description || '';
            document.getElementById('qtyOnHand').value = item.qtyOnHand || 0;
            document.getElementById('stockMin').value = item.stockMin || '';
            document.getElementById('stockMax').value = item.stockMax || '';
            document.getElementById('location').value = item.location || '';
            document.getElementById('skuDropdown').style.display = 'none';
        }

        document.getElementById('menuBtn').addEventListener('click', function() {
            const overlay = document.getElementById('menuOverlay');
            const panel = document.getElementById('menuPanel');
            const isOpen = overlay.style.display === 'block';
            overlay.style.display = isOpen ? 'none' : 'block';
            panel.style.transform = isOpen ? 'translateX(-100%)' : 'translateX(0)';
        });

        document.getElementById('menuOverlay').addEventListener('click', function() {
            this.style.display = 'none';
            document.getElementById('menuPanel').style.transform = 'translateX(-100%)';
        });
        
        const btnRefresh = document.getElementById('btnRefresh');
        if (btnRefresh) {
            btnRefresh.addEventListener('click', async function() {
                this.textContent = '‚ü≥';
                await loadInventory();
                this.textContent = 'üîÑ';
                showNotification('‚úì Refreshed from database');
            });
        }

        function switchToTab(tab) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            const menuItem = document.querySelector('.menu-item[data-tab="' + tab + '"]');
            if (menuItem) menuItem.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            const tabEl = document.getElementById(tab + '-tab');
            if (tabEl) tabEl.style.display = 'block';
            document.getElementById('menuOverlay').style.display = 'none';
            document.getElementById('menuPanel').style.transform = 'translateX(-100%)';
            // Save last active tab
            localStorage.setItem('lastActiveTab', tab);
            // Tab-specific init
            if (tab === 'dashboard') updateDashboard();
            if (tab === 'inventory') displayInventory();
            if (tab === 'count-reports') displayCountReports();
            if (tab === 'stock-entry') {
                const selector = document.getElementById('skuFormatSelector');
                if (selector && lastUsedFormat) {
                    selector.value = lastUsedFormat;
                    switchSKUFormat(lastUsedFormat);
                }
            }
            if (tab === 'qb-reconcile') {
                document.getElementById('qbUploadScreen').style.display  = 'block';
                document.getElementById('qbSessionScreen').style.display = 'none';
                document.getElementById('qbResultsScreen').style.display = 'none';
                document.getElementById('qbVerifyCard').style.display    = 'none';
                qbInitTab();
            }
            if (tab === 'tasks') {
                document.getElementById('tasksListScreen').style.display   = 'block';
                document.getElementById('tasksFormScreen').style.display   = 'none';
                document.getElementById('tasksDetailScreen').style.display = 'none';
                tasksInit();
            }
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                if (tab) switchToTab(tab);
            });
        });

        document.getElementById('btnAddItem').addEventListener('click', () => {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('.menu-item')[1].classList.add('active');
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById('add-edit-tab').style.display = 'block';
        });

        document.getElementById('btnSave').addEventListener('click', saveItem);
        document.getElementById('btnClear').addEventListener('click', clearForm);
        document.getElementById('btnExport').addEventListener('click', exportCSV);
        document.getElementById('btnExport2').addEventListener('click', exportCSV);
        document.getElementById('btnImport').addEventListener('click', () => document.getElementById('csvFile').click());
        document.getElementById('csvFile').addEventListener('change', importCSV);
        document.getElementById('btnImportPaste').addEventListener('click', importFromPaste);
        document.getElementById('searchBox').addEventListener('input', displayInventory);
        document.getElementById('btnDeleteSelected').addEventListener('click', deleteSelectedItems);

        function showLoading(show, text = 'Loading...') {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
            document.getElementById('loadingText').textContent = text;
        }

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.display = 'block';
            notif.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
            notif.style.color = type === 'success' ? '#065f46' : '#991b1b';
            setTimeout(() => notif.style.display = 'none', 4000);
        }

        function updateDashboard() {
            document.getElementById('statTotal').textContent = inventory.length;
            document.getElementById('statLowStock').textContent = inventory.filter(i => i.qtyOnHand > 0 && i.stockMin && i.qtyOnHand <= i.stockMin).length;
            document.getElementById('statOutStock').textContent = inventory.filter(i => i.qtyOnHand === 0).length;
        }

        async function loadInventory() {
            try {
                showLoading(true);
                
                // Load in batches to bypass Supabase 1000 row limit
                let allData = [];
                let page = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const start = page * pageSize;
                    const end = start + pageSize - 1;
                    
                    const { data, error } = await db
                        .from('inventory')
                        .select('*')
                        .order('sku')
                        .range(start, end);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        page++;
                        hasMore = data.length === pageSize; // Stop if we got less than a full page
                    } else {
                        hasMore = false;
                    }
                }
                
                inventory = allData.map(item => ({
                    sku: item.sku,
                    description: item.description,
                    qtyOnHand: item.qty_on_hand,
                    stockMin: item.stock_min,
                    stockMax: item.stock_max,
                    location: item.location
                }));
                console.log('Loaded inventory items:', inventory.length);
                updateDashboard();
                displayInventory();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveItem() {
            const sku = document.getElementById('sku').value.trim().toUpperCase();
            if (!sku) return showNotification('Please enter SKU', 'error');
            try {
                showLoading(true);
                const { error } = await db.from('inventory').upsert({
                    sku,
                    description: document.getElementById('description').value.trim(),
                    qty_on_hand: parseInt(document.getElementById('qtyOnHand').value) || 0,
                    stock_min: document.getElementById('stockMin').value ? parseInt(document.getElementById('stockMin').value) : null,
                    stock_max: document.getElementById('stockMax').value ? parseInt(document.getElementById('stockMax').value) : null,
                    location: document.getElementById('location').value.trim().toUpperCase(),
                    updated_at: new Date().toISOString()
                }, { onConflict: 'sku' });
                if (error) throw error;
                await loadInventory();
                clearForm();
                showNotification('Saved!');
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function clearForm() {
            document.getElementById('sku').value = '';
            document.getElementById('description').value = '';
            document.getElementById('qtyOnHand').value = '';
            document.getElementById('stockMin').value = '';
            document.getElementById('stockMax').value = '';
            document.getElementById('location').value = '';
        }

        function displayInventory() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const filtered = inventory.filter(i => i.sku.toLowerCase().includes(search) || (i.description && i.description.toLowerCase().includes(search)));
            document.getElementById('itemCount').textContent = filtered.length + ' items';
            
            const div = document.getElementById('inventoryTable');
            if (filtered.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">No items</p>';
                document.getElementById('massDeleteControls').style.display = 'none';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0; width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)" style="cursor: pointer;"></th>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">SKU</th>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">Description</th>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">QOH</th>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">Location</th>';
            html += '<th style="padding: 12px; text-align: left; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">Actions</th>';
            html += '</tr></thead><tbody>';
            
            filtered.forEach(item => {
                const isSelected = selectedItems.has(item.sku);
                html += '<tr>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9;"><input type="checkbox" class="item-checkbox" data-sku="' + item.sku + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleItemSelection(\'' + item.sku + '\', this.checked)" style="cursor: pointer;"></td>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9;"><strong>' + item.sku + '</strong></td>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9;">' + (item.description || '-') + '</td>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9; font-weight: 600;">' + (item.qtyOnHand || 0) + '</td>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9;">' + (item.location || '-') + '</td>';
                html += '<td style="padding: 12px; border-bottom: 1px solid #f1f5f9;"><button onclick="editItem(\'' + item.sku + '\')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 4px;">Edit</button>';
                html += '<button onclick="deleteItem(\'' + item.sku + '\')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">Del</button></td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            div.innerHTML = html;
            updateMassDeleteControls();
        }
        
        function toggleSelectAll(checked) {
            selectedItems.clear();
            if (checked) {
                const search = document.getElementById('searchBox').value.toLowerCase();
                const filtered = inventory.filter(i => i.sku.toLowerCase().includes(search) || (i.description && i.description.toLowerCase().includes(search)));
                filtered.forEach(item => selectedItems.add(item.sku));
            }
            displayInventory();
        }
        
        function toggleItemSelection(sku, checked) {
            if (checked) {
                selectedItems.add(sku);
            } else {
                selectedItems.delete(sku);
            }
            updateMassDeleteControls();
        }
        
        function updateMassDeleteControls() {
            const controls = document.getElementById('massDeleteControls');
            const countSpan = document.getElementById('selectedCount');
            
            if (selectedItems.size > 0) {
                controls.style.display = 'block';
                countSpan.textContent = selectedItems.size;
            } else {
                controls.style.display = 'none';
            }
        }
        
        async function deleteSelectedItems() {
            if (selectedItems.size === 0) return;
            
            const count = selectedItems.size;
            if (!confirm('Delete ' + count + ' selected item' + (count > 1 ? 's' : '') + '?')) return;
            
            try {
                showLoading(true, 'Deleting ' + count + ' items...');
                
                const skusToDelete = Array.from(selectedItems);
                const { error } = await db.from('inventory').delete().in('sku', skusToDelete);
                
                if (error) throw error;
                
                selectedItems.clear();
                await loadInventory();
                showNotification('Deleted ' + count + ' items');
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editItem(sku) {
            const item = inventory.find(i => i.sku === sku);
            if (!item) return;
            document.getElementById('sku').value = item.sku;
            document.getElementById('description').value = item.description || '';
            document.getElementById('qtyOnHand').value = item.qtyOnHand || 0;
            document.getElementById('stockMin').value = item.stockMin || '';
            document.getElementById('stockMax').value = item.stockMax || '';
            document.getElementById('location').value = item.location || '';
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById('add-edit-tab').style.display = 'block';
        }

        async function deleteItem(sku) {
            if (!confirm('Delete ' + sku + '?')) return;
            try {
                showLoading(true);
                const { error } = await db.from('inventory').delete().eq('sku', sku);
                if (error) throw error;
                await loadInventory();
                showNotification('Deleted');
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => await processCSV(e.target.result);
            reader.readAsText(file);
        }

        async function importFromPaste() {
            const text = document.getElementById('csvPaste').value.trim();
            if (!text) return showNotification('Paste CSV first', 'error');
            await processCSV(text);
            document.getElementById('csvPaste').value = '';
        }

        async function processCSV(text) {
            try {
                showLoading(true);
                const lines = text.trim().split('\n');
                const items = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || (i === 0 && line.toLowerCase().includes('sku'))) continue;
                    const parts = line.split(',').map(p => p.trim().replace(/^["']|["']$/g, ''));
                    if (parts.length < 3) continue;
                    const sku = parts[0].toUpperCase();
                    if (!sku) continue;
                    items.push({
                        sku,
                        description: parts[1] || '',
                        qty_on_hand: parseInt(parts[2]) || 0,
                        stock_min: parts[3] ? parseInt(parts[3]) : null,
                        stock_max: parts[4] ? parseInt(parts[4]) : null,
                        location: parts[5] ? parts[5].toUpperCase() : '',
                        updated_at: new Date().toISOString()
                    });
                }
                if (items.length === 0) return showNotification('No valid items', 'error');
                const { error } = await db.from('inventory').upsert(items, { onConflict: 'sku' });
                if (error) throw error;
                await loadInventory();
                showNotification('Imported ' + items.length + ' items!');
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function exportCSV() {
            if (inventory.length === 0) return showNotification('No items', 'error');
            let csv = 'SKU,Description,Qty on Hand,Min,Max,Location\n';
            inventory.forEach(i => {
                csv += '"' + i.sku + '","' + (i.description || '') + '",' + (i.qtyOnHand || 0) + ',' + (i.stockMin || '') + ',' + (i.stockMax || '') + ',"' + (i.location || '') + '"\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventory_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Exported ' + inventory.length + ' items');
        }

        // Physical Count Functions
        document.getElementById('btnStartCount').addEventListener('click', startCountSession);
        document.getElementById('btnSaveCount').addEventListener('click', saveCurrentCount);
        document.getElementById('btnSkipItem').addEventListener('click', skipCurrentItem);
        document.getElementById('btnPrevItem').addEventListener('click', previousItem);
        document.getElementById('btnFinishCount').addEventListener('click', finishCountSession);
        document.getElementById('btnMinus').addEventListener('click', () => {
            const input = document.getElementById('actualCount');
            const val = parseInt(input.value) || 0;
            if (val > 0) input.value = val - 1;
            updateVarianceDisplay();
        });
        document.getElementById('btnPlus').addEventListener('click', () => {
            const input = document.getElementById('actualCount');
            input.value = (parseInt(input.value) || 0) + 1;
            updateVarianceDisplay();
        });
        document.getElementById('actualCount').addEventListener('input', updateVarianceDisplay);
        
        // Make input editable when tapped
        document.getElementById('actualCount').addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.select();
        });
        
        // Make readonly again after blur to prevent accidental keyboard opening
        document.getElementById('actualCount').addEventListener('blur', function() {
            this.setAttribute('readonly', 'readonly');
        });
        
        function startCountSession() {
            const sessionName = document.getElementById('sessionNameInput').value.trim() || 'Count Session';
            const sortOrder = document.getElementById('countSortOrder').value;
            const locationFilter = document.getElementById('locationFilter').value.trim().toUpperCase();
            const brandFilter = document.getElementById('brandFilter').value.trim().toUpperCase();
            
            let itemsToCount = [...inventory];
            
            // Apply location filter
            if (locationFilter) {
                itemsToCount = itemsToCount.filter(item => 
                    item.location && item.location.toUpperCase().startsWith(locationFilter)
                );
            }
            
            // Apply brand filter (extract prefix before first number or dash)
            if (brandFilter) {
                itemsToCount = itemsToCount.filter(item => {
                    const prefix = item.sku.match(/^([A-Z]+)/i);
                    return prefix && prefix[1].toUpperCase() === brandFilter;
                });
            }
            
            if (itemsToCount.length === 0) {
                showNotification('No items match the filter', 'error');
                return;
            }
            
            if (sortOrder === 'location') {
                itemsToCount.sort((a, b) => (a.location || '').localeCompare(b.location || ''));
            } else {
                itemsToCount.sort((a, b) => a.sku.localeCompare(b.sku));
            }
            
            currentSession = {
                id: Date.now(),
                name: sessionName,
                startTime: new Date().toISOString(),
                sortOrder: sortOrder === 'location' ? 'Location' : 'SKU',
                locationFilter: locationFilter || 'All',
                brandFilter: brandFilter || 'All',
                items: itemsToCount.map(item => ({
                    sku: item.sku,
                    description: item.description,
                    location: item.location,
                    systemQty: item.qtyOnHand,
                    actualQty: null,
                    variance: null,
                    counted: false
                }))
            };
            
            currentItemIndex = 0;
            countedItems = [];
            
            document.getElementById('startCountScreen').style.display = 'none';
            document.getElementById('countSession').style.display = 'block';
            document.getElementById('sessionName').textContent = sessionName;
            document.getElementById('sortMethod').textContent = currentSession.sortOrder;
            
            displayCurrentItem();
        }
        
        function displayCurrentItem() {
            if (!currentSession || currentItemIndex >= currentSession.items.length) {
                finishCountSession();
                return;
            }
            
            const item = currentSession.items[currentItemIndex];
            const counted = countedItems.filter(i => i.counted).length;
            
            document.getElementById('countProgress').textContent = counted + '/' + currentSession.items.length;
            document.getElementById('countSKU').textContent = item.sku;
            document.getElementById('countDescription').textContent = item.description || '-';
            document.getElementById('countLocation').textContent = item.location || '-';
            document.getElementById('systemQty').textContent = item.systemQty || 0;
            
            const actualInput = document.getElementById('actualCount');
            if (item.actualQty !== null) {
                actualInput.value = item.actualQty;
            } else {
                actualInput.value = item.systemQty || 0;
            }
            
            updateVarianceDisplay();
            
            document.getElementById('btnPrevItem').disabled = currentItemIndex === 0;
            document.getElementById('btnPrevItem').style.opacity = currentItemIndex === 0 ? '0.5' : '1';
        }
        
        function updateVarianceDisplay() {
            const systemQty = parseInt(document.getElementById('systemQty').textContent) || 0;
            const actualQty = parseInt(document.getElementById('actualCount').value) || 0;
            const variance = actualQty - systemQty;
            const display = document.getElementById('varianceDisplay');
            
            if (variance === 0) {
                display.style.display = 'none';
            } else {
                display.style.display = 'block';
                display.textContent = 'Variance: ' + (variance > 0 ? '+' : '') + variance;
                display.style.background = variance > 0 ? '#dbeafe' : '#fef3c7';
                display.style.color = variance > 0 ? '#1e40af' : '#92400e';
            }
        }
        
        async function saveCurrentCount() {
            const item = currentSession.items[currentItemIndex];
            const actualQty = parseInt(document.getElementById('actualCount').value) || 0;
            
            item.actualQty = actualQty;
            item.variance = actualQty - (item.systemQty || 0);
            item.counted = true;
            item.countedAt = new Date().toISOString();
            
            if (item.variance !== 0) {
                try {
                    await db.from('inventory').update({
                        qty_on_hand: actualQty,
                        updated_at: new Date().toISOString()
                    }).eq('sku', item.sku);
                    
                    const invItem = inventory.find(i => i.sku === item.sku);
                    if (invItem) invItem.qtyOnHand = actualQty;
                } catch (e) {
                    showNotification('Error updating: ' + e.message, 'error');
                }
            }
            
            currentItemIndex++;
            displayCurrentItem();
        }
        
        function skipCurrentItem() {
            currentItemIndex++;
            displayCurrentItem();
        }
        
        function previousItem() {
            if (currentItemIndex > 0) {
                currentItemIndex--;
                displayCurrentItem();
            }
        }
        
        async function finishCountSession() {
            if (!currentSession) return;
            
            currentSession.endTime = new Date().toISOString();
            currentSession.completed = true;
            
            const counted = currentSession.items.filter(i => i.counted).length;
            const withVariance = currentSession.items.filter(i => i.counted && i.variance !== 0).length;
            
            currentSession.summary = {
                totalItems: currentSession.items.length,
                counted: counted,
                withVariance: withVariance
            };
            
            countSessions.push(currentSession);
            localStorage.setItem('countSessions', JSON.stringify(countSessions));
            
            document.getElementById('countSession').style.display = 'none';
            document.getElementById('startCountScreen').style.display = 'block';
            document.getElementById('sessionNameInput').value = '';
            document.getElementById('locationFilter').value = '';
            
            showNotification('Count session completed! ' + counted + ' items counted, ' + withVariance + ' with changes');
            
            currentSession = null;
            await loadInventory();
        }
        
        function displayCountReports() {
            const savedSessions = localStorage.getItem('countSessions');
            if (savedSessions) {
                countSessions = JSON.parse(savedSessions);
            }
            
            document.getElementById('reportsCount').textContent = countSessions.length + ' report' + (countSessions.length !== 1 ? 's' : '');
            
            const listDiv = document.getElementById('reportsList');
            if (countSessions.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #94a3b8;">No count sessions yet</div>';
                return;
            }
            
            let html = '';
            countSessions.slice().reverse().forEach((session, index) => {
                const realIndex = countSessions.length - 1 - index;
                html += '<div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
                html += '<div><h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">' + session.name + '</h3>';
                html += '<div style="font-size: 13px; color: #64748b;">' + new Date(session.startTime).toLocaleString() + '</div></div>';
                html += '<span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; background: #d1fae5; color: #065f46;">COMPLETED</span>';
                html += '</div>';
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">';
                html += '<div style="text-align: center; padding: 8px; background: #f8fafc; border-radius: 6px;"><div style="font-size: 18px; font-weight: 700;">' + session.summary.totalItems + '</div><div style="font-size: 12px; color: #64748b;">Total</div></div>';
                html += '<div style="text-align: center; padding: 8px; background: #f8fafc; border-radius: 6px;"><div style="font-size: 18px; font-weight: 700;">' + session.summary.counted + '</div><div style="font-size: 12px; color: #64748b;">Counted</div></div>';
                html += '<div style="text-align: center; padding: 8px; background: #f8fafc; border-radius: 6px;"><div style="font-size: 18px; font-weight: 700; color: #f59e0b;">' + session.summary.withVariance + '</div><div style="font-size: 12px; color: #64748b;">Changed</div></div>';
                html += '</div>';
                html += '<div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Sorted by: ' + session.sortOrder + ' | Filter: ' + session.locationFilter + '</div>';
                html += '<button onclick="exportCountSession(' + realIndex + ')" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white; margin-right: 8px;">üì• Export CSV</button>';
                html += '<button onclick="viewCountDetails(' + realIndex + ')" style="padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #64748b; color: white;">üëÅÔ∏è View Details</button>';
                html += '</div>';
            });
            
            listDiv.innerHTML = html;
        }
        
        function exportCountSession(index) {
            const session = countSessions[index];
            let csv = 'Physical Count Report\n';
            csv += 'Session: ' + session.name + '\n';
            csv += 'Date: ' + new Date(session.startTime).toLocaleString() + '\n';
            csv += 'Sort Order: ' + session.sortOrder + '\n';
            csv += 'Location Filter: ' + session.locationFilter + '\n\n';
            csv += 'SKU,Description,Location,System Qty,Actual Qty,Variance,Counted At\n';
            
            session.items.forEach(item => {
                if (item.counted) {
                    csv += '"' + item.sku + '","' + (item.description || '') + '","' + (item.location || '') + '",';
                    csv += (item.systemQty || 0) + ',' + (item.actualQty || 0) + ',' + (item.variance || 0) + ',';
                    csv += '"' + (item.countedAt ? new Date(item.countedAt).toLocaleString() : '') + '"\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Count_' + session.name.replace(/\s+/g, '_') + '_' + new Date(session.startTime).toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Report exported');
        }
        
        function viewCountDetails(index) {
            const session = countSessions[index];
            alert('Session: ' + session.name + '\n\nTotal Items: ' + session.summary.totalItems + '\nCounted: ' + session.summary.counted + '\nWith Changes: ' + session.summary.withVariance + '\n\nUse Export CSV to get full details for QuickBooks.');
        }

        // Scan Count Functions
        document.getElementById('btnStartScanCount').addEventListener('click', startScanCountSession);
        const btnTakePicture = document.getElementById('btnTakePicture');
        if (btnTakePicture) {
            btnTakePicture.addEventListener('click', () => document.getElementById('cameraInput').click());
        }
        
        const cameraInput = document.getElementById('cameraInput');
        if (cameraInput) {
            cameraInput.addEventListener('change', handlePhotoCapture);
        }
        
        const btnManualSearch = document.getElementById('btnManualSearch');
        if (btnManualSearch) {
            btnManualSearch.addEventListener('click', showManualSearch);
        }
        
        const btnCancelManual = document.getElementById('btnCancelManual');
        if (btnCancelManual) {
            btnCancelManual.addEventListener('click', hideManualSearch);
        }
        
        const btnRescan = document.getElementById('btnRescan');
        if (btnRescan) {
            btnRescan.addEventListener('click', showScanCamera);
        }
        
        const btnSaveScanCount = document.getElementById('btnSaveScanCount');
        if (btnSaveScanCount) {
            btnSaveScanCount.addEventListener('click', saveScanCount);
        }
        
        const btnCancelScan = document.getElementById('btnCancelScan');
        if (btnCancelScan) {
            btnCancelScan.addEventListener('click', cancelScanCount);
        }
        document.getElementById('btnFinishScanCount').addEventListener('click', finishScanCountSession);
        
        document.getElementById('btnScanMinus').addEventListener('click', () => {
            const input = document.getElementById('scanActualCount');
            const val = parseInt(input.value) || 0;
            if (val > 0) input.value = val - 1;
            updateScanVarianceDisplay();
        });
        
        document.getElementById('btnScanPlus').addEventListener('click', () => {
            const input = document.getElementById('scanActualCount');
            input.value = (parseInt(input.value) || 0) + 1;
            updateScanVarianceDisplay();
        });
        
        document.getElementById('scanActualCount').addEventListener('input', updateScanVarianceDisplay);
        document.getElementById('scanActualCount').addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.select();
        });
        document.getElementById('scanActualCount').addEventListener('blur', function() {
            this.setAttribute('readonly', 'readonly');
        });
        
        // Manual Count with device keyboard
        
        // Old event listener cleanup
        document.getElementById('manualSKUInput') && document.getElementById('manualSKUInput').addEventListener('input', function(e) {
            const value = e.target.value.toUpperCase();
            const dropdown = document.getElementById('manualSKUDropdown') || document.getElementById('skuDropdown');
            if (!dropdown) return;
            
            if (value.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = inventory.filter(item => 
                item.sku.toUpperCase().includes(value)
            ).slice(0, 10);
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            let html = '';
            matches.forEach(item => {
                html += '<div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9;" onclick="selectManualSKU(\'' + item.sku + '\')">';
                html += '<div style="font-weight: 600;">' + item.sku + '</div>';
                if (item.description) html += '<div style="font-size: 13px; color: #64748b;">' + item.description + '</div>';
                html += '</div>';
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        });
        
        function selectManualSKU(sku) {
            const item = inventory.find(i => i.sku === sku);
            if (item) {
                document.getElementById('manualSKUDropdown').style.display = 'none';
                document.getElementById('manualSKUInput').value = '';
                hideManualSearch();
                loadScanItem(item);
            }
        }
        
        function startScanCountSession() {
            const sessionName = document.getElementById('scanSessionName').value.trim() || 'Scan Count Session';
            
            scanCountSession = {
                id: Date.now(),
                name: sessionName,
                startTime: new Date().toISOString(),
                items: []
            };
            
            scanCountedItems = [];
            
            document.getElementById('startScanCountScreen').style.display = 'none';
            document.getElementById('scanCountSession').style.display = 'block';
            updateScanProgress();
            showManualSearch(); // Go directly to manual keyboard
        }
        
        function showScanCamera() {
            // Camera removed - show manual keyboard instead
            showManualSearch();
        }
        
        function showManualSearch() {
            document.getElementById('manualSearchScreen').style.display = 'block';
            document.getElementById('scanCameraScreen').style.display = 'none';
            
            const input = document.getElementById('manualSKUInput');
            input.value = '';
            setTimeout(() => input.focus(), 100);
            
            input.oninput = function() {
                checkForMatches();
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const sku = this.value.trim().toUpperCase();
                    if (sku) {
                        loadScanItem(sku);
                    }
                }
            };
        }
        
        function hideManualSearch() {
            document.getElementById('quickMatchDropdown').style.display = 'none';
            document.getElementById('manualSearchScreen').style.display = 'none';
        }
        
        function checkForMatches() {
            const input = document.getElementById('manualSKUInput').value.trim().toUpperCase();
            const dropdown = document.getElementById('quickMatchDropdown');
            
            if (input.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = inventory.filter(item => 
                item.sku.toUpperCase().includes(input)
            ).slice(0, 5);
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            let html = '';
            matches.forEach(item => {
                const alreadyCounted = scanCountedItems.includes(item.sku);
                const badge = alreadyCounted ? ' <span style="color: #10b981;">‚úì</span>' : '';
                
                html += '<div style="padding: 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="selectQuickMatch(\'' + item.sku + '\')">';
                html += '<div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">' + item.sku + badge + '</div>';
                if (item.description) html += '<div style="font-size: 13px; color: #64748b;">' + item.description + '</div>';
                if (item.location) html += '<div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">üìç ' + item.location + '</div>';
                html += '</div>';
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        function selectQuickMatch(sku) {
            document.getElementById('manualSKUInput').value = '';
            document.getElementById('quickMatchDropdown').style.display = 'none';
            loadScanItem(sku);
        }
        
        async function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Photo captured, starting OCR...');
            
            // Show loading
            const cameraScreen = document.getElementById('scanCameraScreen');
            cameraScreen.innerHTML = '<div style="background: white; padding: 40px; border-radius: 12px; text-align: center;"><div style="border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div><div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">Reading label...</div><div style="font-size: 14px; color: #64748b;" id="ocrProgress">Initializing OCR...</div></div>';
            
            try {
                // Check if Tesseract is loaded
                if (typeof Tesseract === 'undefined') {
                    throw new Error('OCR library not loaded. Please refresh the page.');
                }
                
                document.getElementById('ocrProgress').textContent = 'Processing image...';
                
                const result = await Tesseract.recognize(file, 'eng', {
                    logger: (m) => {
                        console.log(m);
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            document.getElementById('ocrProgress').textContent = 'Reading: ' + percent + '%';
                        }
                    }
                });
                
                console.log('OCR complete. Raw text:', result.data.text);
                
                const text = result.data.text;
                const detectedSKUs = extractSKUs(text);
                
                console.log('Detected SKUs:', detectedSKUs);
                
                // Reset camera screen
                resetCameraScreen();
                
                if (detectedSKUs.length === 0) {
                    // Show what was detected for debugging
                    alert('No matching SKUs found.\n\nDetected text:\n' + text.substring(0, 200) + '\n\nTry:\n- Get closer to label\n- Better lighting\n- Or type manually');
                    return;
                }
                
                if (detectedSKUs.length === 1) {
                    // Auto-load single match
                    const item = inventory.find(i => i.sku === detectedSKUs[0]);
                    if (item) {
                        loadScanItem(item);
                    } else {
                        showNotification('SKU ' + detectedSKUs[0] + ' not found in inventory', 'error');
                    }
                } else {
                    // Show picker for multiple matches
                    showSKUPicker(detectedSKUs);
                }
            } catch (error) {
                console.error('OCR Error:', error);
                resetCameraScreen();
                alert('Error processing image:\n\n' + error.message + '\n\nPlease try again or type manually.');
            }
        }
        
        function resetCameraScreen() {
            const cameraScreen = document.getElementById('scanCameraScreen');
            cameraScreen.innerHTML = '<div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;"><div style="font-size: 48px; margin-bottom: 16px;">üì∑</div><h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">Scan Item Label</h3><p style="color: #64748b; margin-bottom: 20px;">Point camera at SKU/Part Number</p><input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;"><button id="btnTakePicture" style="width: 100%; padding: 20px; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; background: #3b82f6; color: white; margin-bottom: 12px;">üì∏ Take Picture</button><button id="btnManualSearch" style="width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f1f5f9; color: #64748b;">‚å®Ô∏è Type SKU Manually</button></div>';
            
            // Attach event listeners to newly created elements
            const btnTakePic = document.getElementById('btnTakePicture');
            if (btnTakePic) {
                btnTakePic.addEventListener('click', () => document.getElementById('cameraInput').click());
            }
            
            const camInput = document.getElementById('cameraInput');
            if (camInput) {
                camInput.addEventListener('change', handlePhotoCapture);
            }
            
            const btnManual = document.getElementById('btnManualSearch');
            if (btnManual) {
                btnManual.addEventListener('click', showManualSearch);
            }
        }
        
        function extractSKUs(text) {
            const skus = [];
            const lines = text.split('\n');
            
            // Pattern matching for common SKU formats
            const patterns = [
                /\b(MW\d{4}-\d{4}-[A-Z]{3})\b/gi,  // MW2018-7615-BSK
                /\b(GH\d{3}[A-Z]-\d{3})\b/gi,      // GH123A-456
                /\b(P\d{6})\b/gi,                  // P165789
                /\b(\d{4}-\d{4}-[A-Z]{3})\b/gi,    // 2018-7615-BSK
                /\b([A-Z]{2}\d{4,8})\b/gi          // MW20187615
            ];
            
            patterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        const normalized = match.toUpperCase();
                        // Check if this SKU exists in inventory
                        if (inventory.find(i => i.sku === normalized)) {
                            if (!skus.includes(normalized)) {
                                skus.push(normalized);
                            }
                        }
                    });
                }
            });
            
            return skus;
        }
        
        function showSKUPicker(detectedSKUs) {
            document.getElementById('scanCameraScreen').style.display = 'none';
            document.getElementById('skuPickerScreen').style.display = 'block';
            
            const container = document.getElementById('detectedSKUs');
            let html = '';
            
            detectedSKUs.forEach(sku => {
                const item = inventory.find(i => i.sku === sku);
                if (item) {
                    html += '<div style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; cursor: pointer;" onclick="selectDetectedSKU(\'' + sku + '\')">';
                    html += '<div style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">' + sku + '</div>';
                    if (item.description) html += '<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">' + item.description + '</div>';
                    html += '<div style="font-size: 13px; color: #94a3b8;">QOH: ' + (item.qtyOnHand || 0) + ' | Loc: ' + (item.location || '-') + '</div>';
                    html += '</div>';
                }
            });
            
            container.innerHTML = html;
        }
        
        function selectDetectedSKU(sku) {
            const item = inventory.find(i => i.sku === sku);
            if (item) {
                loadScanItem(item);
            }
        }
        
        function loadScanItem(item) {
            document.getElementById('scanCameraScreen').style.display = 'none';
            document.getElementById('skuPickerScreen').style.display = 'none';
            document.getElementById('scanItemCard').style.display = 'block';
            
            document.getElementById('scanSKU').textContent = item.sku;
            document.getElementById('scanDescription').textContent = item.description || '-';
            document.getElementById('scanLocation').textContent = item.location || '-';
            document.getElementById('scanSystemQty').textContent = item.qtyOnHand || 0;
            document.getElementById('scanActualCount').value = item.qtyOnHand || 0;
            
            updateScanVarianceDisplay();
        }
        
        function updateScanVarianceDisplay() {
            const systemQty = parseInt(document.getElementById('scanSystemQty').textContent) || 0;
            const actualQty = parseInt(document.getElementById('scanActualCount').value) || 0;
            const variance = actualQty - systemQty;
            const display = document.getElementById('scanVarianceDisplay');
            
            if (variance === 0) {
                display.style.display = 'none';
            } else {
                display.style.display = 'block';
                display.textContent = 'Variance: ' + (variance > 0 ? '+' : '') + variance;
                display.style.background = variance > 0 ? '#dbeafe' : '#fef3c7';
                display.style.color = variance > 0 ? '#1e40af' : '#92400e';
            }
        }
        
        async function saveScanCount() {
            const sku = document.getElementById('scanSKU').textContent;
            const actualQty = parseInt(document.getElementById('scanActualCount').value) || 0;
            const systemQty = parseInt(document.getElementById('scanSystemQty').textContent) || 0;
            const variance = actualQty - systemQty;
            
            const item = inventory.find(i => i.sku === sku);
            if (!item) return;
            
            const countRecord = {
                sku: sku,
                description: item.description,
                location: item.location,
                systemQty: systemQty,
                actualQty: actualQty,
                variance: variance,
                countedAt: new Date().toISOString()
            };
            
            scanCountSession.items.push(countRecord);
            scanCountedItems.push(sku);
            
            if (variance !== 0) {
                try {
                    await db.from('inventory').update({
                        qty_on_hand: actualQty,
                        updated_at: new Date().toISOString()
                    }).eq('sku', sku);
                    
                    item.qtyOnHand = actualQty;
                } catch (e) {
                    showNotification('Error updating: ' + e.message, 'error');
                }
            }
            
            updateScanProgress();
            showManualSearch(); // Show keyboard for next item
            showNotification('Saved! Count: ' + scanCountedItems.length);
        }
        
        function cancelScanCount() {
            showManualSearch(); // Show keyboard again
        }
        
        function updateScanProgress() {
            document.getElementById('scanProgress').textContent = scanCountedItems.length;
        }
        
        async function finishScanCountSession() {
            if (!scanCountSession || scanCountSession.items.length === 0) {
                showNotification('No items counted', 'error');
                return;
            }
            
            scanCountSession.endTime = new Date().toISOString();
            scanCountSession.completed = true;
            
            const withVariance = scanCountSession.items.filter(i => i.variance !== 0).length;
            
            scanCountSession.summary = {
                totalItems: scanCountSession.items.length,
                counted: scanCountSession.items.length,
                withVariance: withVariance
            };
            
            countSessions.push(scanCountSession);
            localStorage.setItem('countSessions', JSON.stringify(countSessions));
            
            document.getElementById('scanCountSession').style.display = 'none';
            document.getElementById('startScanCountScreen').style.display = 'block';
            document.getElementById('scanSessionName').value = '';
            
            showNotification('Scan count completed! ' + scanCountSession.items.length + ' items counted, ' + withVariance + ' with changes');
            
            scanCountSession = null;
            scanCountedItems = [];
            await loadInventory();
        }

        // Shelf Audit Functions
        document.getElementById('btnStartAudit').addEventListener('click', startAuditSession);
        document.getElementById('btnSaveAudit').addEventListener('click', saveAuditItem);
        document.getElementById('btnCancelAudit').addEventListener('click', cancelAuditItem);
        document.getElementById('btnCancelAuditKeyboard').addEventListener('click', () => {
            if (confirm('Cancel this audit session?')) {
                finishAuditSession();
            }
        });
        document.getElementById('btnFinishAudit').addEventListener('click', finishAuditSession);
        
        document.getElementById('btnAuditMinus').addEventListener('click', () => {
            const input = document.getElementById('auditQty');
            const val = parseInt(input.value) || 0;
            if (val > 0) input.value = val - 1;
        });
        
        document.getElementById('btnAuditPlus').addEventListener('click', () => {
            const input = document.getElementById('auditQty');
            input.value = (parseInt(input.value) || 0) + 1;
        });
        
        document.getElementById('auditQty').addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.select();
        });
        
        document.getElementById('auditQty').addEventListener('blur', function() {
            this.setAttribute('readonly', 'readonly');
        });
        
        // Audit keyboard functions
        function addToAuditSKU(char) {
            currentAuditSKUInput += char;
            updateAuditSKUDisplay();
            checkForAuditMatches();
        }
        
        function backspaceAuditSKU() {
            currentAuditSKUInput = currentAuditSKUInput.slice(0, -1);
            updateAuditSKUDisplay();
            checkForAuditMatches();
        }
        
        function clearAuditSKU() {
            currentAuditSKUInput = '';
            updateAuditSKUDisplay();
            document.getElementById('auditQuickMatchDropdown').style.display = 'none';
        }
        
        function updateAuditSKUDisplay() {
            document.getElementById('auditSkuTyped').textContent = currentAuditSKUInput || '';
        }
        
        function checkForAuditMatches() {
            const dropdown = document.getElementById('auditQuickMatchDropdown');
            
            if (currentAuditSKUInput.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = inventory.filter(item => 
                item.sku.toUpperCase().includes(currentAuditSKUInput.toUpperCase())
            ).slice(0, 5);
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            let html = '<div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #64748b;">Quick Matches:</div>';
            matches.forEach(item => {
                const alreadyAudited = auditedItems.find(a => a.sku === item.sku);
                const auditedBadge = alreadyAudited ? ' <span style="color: #10b981;">‚úì Audited</span>' : '';
                
                html += '<div style="padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="selectAuditSKU(\'' + item.sku + '\')">';
                html += '<div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">' + item.sku + auditedBadge + '</div>';
                if (item.description) html += '<div style="font-size: 13px; color: #64748b;">' + item.description + '</div>';
                html += '</div>';
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        function selectAuditSKU(sku) {
            currentAuditSKUInput = '';
            updateAuditSKUDisplay();
            document.getElementById('auditQuickMatchDropdown').style.display = 'none';
            loadAuditItem(sku);
        }
        
        function startAuditSession() {
            const sessionName = document.getElementById('auditSessionName').value.trim() || 'Shelf Audit';
            const returnListText = document.getElementById('auditReturnList').value.trim();
            
            if (!returnListText) {
                showNotification('Please paste return list', 'error');
                return;
            }
            
            // Parse return list
            const lines = returnListText.split('\n');
            auditReturnList = [];
            
            lines.forEach(line => {
                const sku = line.trim().toUpperCase();
                if (sku && sku !== 'SKU') { // Skip header if present
                    auditReturnList.push(sku);
                }
            });
            
            if (auditReturnList.length === 0) {
                showNotification('No valid SKUs in return list', 'error');
                return;
            }
            
            auditSession = {
                id: Date.now(),
                name: sessionName,
                startTime: new Date().toISOString(),
                returnList: auditReturnList,
                items: []
            };
            
            auditedItems = [];
            
            document.getElementById('startAuditScreen').style.display = 'none';
            document.getElementById('auditSession').style.display = 'block';
            updateAuditProgress();
            showAuditKeyboard();
            showNotification(auditReturnList.length + ' items in return list');
        }
        
        function showAuditKeyboard() {
            document.getElementById('auditKeyboardScreen').style.display = 'block';
            document.getElementById('auditItemCard').style.display = 'none';
        }
        
        function loadAuditItem(sku) {
            // Check if already audited
            const alreadyAudited = auditedItems.find(a => a.sku === sku);
            if (alreadyAudited) {
                if (!confirm('SKU ' + sku + ' already audited with qty ' + alreadyAudited.shelfQty + '. Audit again?')) {
                    return;
                }
            }
            
            const item = inventory.find(i => i.sku === sku);
            const isReturn = auditReturnList.includes(sku);
            
            document.getElementById('auditKeyboardScreen').style.display = 'none';
            document.getElementById('auditItemCard').style.display = 'block';
            
            document.getElementById('auditSKU').textContent = sku;
            document.getElementById('auditDescription').textContent = item ? (item.description || '-') : 'Unknown Item';
            
            // Set badge
            const badge = document.getElementById('auditActionBadge');
            if (isReturn) {
                badge.textContent = 'üî¥ RETURN TO SUPPLIER';
                badge.style.background = '#fee2e2';
                badge.style.color = '#991b1b';
            } else {
                badge.textContent = '‚úÖ KEEP IN STOCK';
                badge.style.background = '#d1fae5';
                badge.style.color = '#065f46';
            }
            
            // Set inventory status
            const inInventory = document.getElementById('auditInInventory');
            if (!item) {
                inInventory.textContent = '‚ö†Ô∏è Not in inventory system';
                inInventory.style.color = '#f59e0b';
            } else {
                inInventory.textContent = 'Location: ' + (item.location || 'Not set');
                inInventory.style.color = '#64748b';
            }
            
            // Set qty (from previous audit or 0)
            document.getElementById('auditQty').value = alreadyAudited ? alreadyAudited.shelfQty : 0;
        }
        
        function saveAuditItem() {
            const sku = document.getElementById('auditSKU').textContent;
            const shelfQty = parseInt(document.getElementById('auditQty').value) || 0;
            const isReturn = auditReturnList.includes(sku);
            const item = inventory.find(i => i.sku === sku);
            
            // Remove if already audited
            auditedItems = auditedItems.filter(a => a.sku !== sku);
            
            const auditRecord = {
                sku: sku,
                description: item ? item.description : 'Unknown',
                action: isReturn ? 'RETURN' : 'KEEP',
                shelfQty: shelfQty,
                inInventory: item ? 'Yes' : 'No',
                location: item ? item.location : '',
                auditedAt: new Date().toISOString()
            };
            
            auditedItems.push(auditRecord);
            auditSession.items = auditedItems;
            
            updateAuditProgress();
            showAuditKeyboard();
            showNotification('‚úì ' + sku + ' audited');
        }
        
        function cancelAuditItem() {
            showAuditKeyboard();
        }
        
        function updateAuditProgress() {
            const returnCount = auditedItems.filter(i => i.action === 'RETURN').length;
            const keepCount = auditedItems.filter(i => i.action === 'KEEP').length;
            
            document.getElementById('auditProgress').textContent = auditedItems.length;
            document.getElementById('auditReturnCount').textContent = returnCount;
            document.getElementById('auditKeepCount').textContent = keepCount;
        }
        
        function finishAuditSession() {
            if (!auditSession || auditedItems.length === 0) {
                showNotification('No items audited', 'error');
                return;
            }
            
            auditSession.endTime = new Date().toISOString();
            auditSession.completed = true;
            
            const returnCount = auditedItems.filter(i => i.action === 'RETURN').length;
            const keepCount = auditedItems.filter(i => i.action === 'KEEP').length;
            
            auditSession.summary = {
                total: auditedItems.length,
                returned: returnCount,
                kept: keepCount
            };
            
            // Save to count sessions for export
            countSessions.push(auditSession);
            localStorage.setItem('countSessions', JSON.stringify(countSessions));
            
            // Export immediately
            exportAuditSession();
            
            document.getElementById('auditSession').style.display = 'none';
            document.getElementById('startAuditScreen').style.display = 'block';
            document.getElementById('auditSessionName').value = '';
            document.getElementById('auditReturnList').value = '';
            
            showNotification('Audit complete! ' + returnCount + ' RETURN, ' + keepCount + ' KEEP');
            
            auditSession = null;
            auditedItems = [];
            auditReturnList = [];
        }
        
        function exportAuditSession() {
            const session = auditSession;
            let csv = 'Shelf Audit Report\n';
            csv += 'Session: ' + session.name + '\n';
            csv += 'Date: ' + new Date(session.startTime).toLocaleString() + '\n';
            csv += 'Return List Size: ' + session.returnList.length + '\n\n';
            csv += 'SKU,Description,Action,Shelf Qty,In Inventory,Location,Audited At\n';
            
            session.items.forEach(item => {
                csv += '"' + item.sku + '","' + (item.description || '') + '","' + item.action + '",';
                csv += item.shelfQty + ',"' + item.inInventory + '","' + (item.location || '') + '",';
                csv += '"' + new Date(item.auditedAt).toLocaleString() + '"\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Audit_' + session.name.replace(/\s+/g, '_') + '_' + new Date(session.startTime).toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // PO Review Functions
        document.getElementById('btnStartPOReview').addEventListener('click', startPOReviewSession);
        document.getElementById('btnSavePOReview').addEventListener('click', savePOReviewItem);
        document.getElementById('btnCancelPOReview').addEventListener('click', () => showPOReviewKeyboard());
        document.getElementById('btnCancelPOReviewKeyboard').addEventListener('click', () => {
            if (confirm('Cancel this PO review session?')) {
                finishPOReviewSession();
            }
        });
        document.getElementById('btnFinishPOReview').addEventListener('click', finishPOReviewSession);
        
        // Shelf qty buttons
        document.getElementById('btnPOShelfMinus').addEventListener('click', () => {
            const input = document.getElementById('poShelfQty');
            const val = parseInt(input.value) || 0;
            if (val > 0) input.value = val - 1;
            updatePOCalculation();
        });
        
        document.getElementById('btnPOShelfPlus').addEventListener('click', () => {
            const input = document.getElementById('poShelfQty');
            input.value = (parseInt(input.value) || 0) + 1;
            updatePOCalculation();
        });
        
        document.getElementById('poShelfQty').addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.select();
        });
        
        document.getElementById('poShelfQty').addEventListener('blur', function() {
            this.setAttribute('readonly', 'readonly');
            updatePOCalculation();
        });
        
        // Order qty buttons
        document.getElementById('btnPOOrderMinus').addEventListener('click', () => {
            const input = document.getElementById('poOrderQty');
            const val = parseInt(input.value) || 0;
            if (val > 0) input.value = val - 1;
            updatePOCalculation();
        });
        
        document.getElementById('btnPOOrderPlus').addEventListener('click', () => {
            const input = document.getElementById('poOrderQty');
            input.value = (parseInt(input.value) || 0) + 1;
            updatePOCalculation();
        });
        
        document.getElementById('poOrderQty').addEventListener('click', function() {
            this.removeAttribute('readonly');
            this.select();
        });
        
        document.getElementById('poOrderQty').addEventListener('blur', function() {
            this.setAttribute('readonly', 'readonly');
            updatePOCalculation();
        });
        
        // Min/Max change listeners
        document.getElementById('poMinStock').addEventListener('input', updatePOCalculation);
        document.getElementById('poMaxStock').addEventListener('input', updatePOCalculation);
        
        // PO Review keyboard functions
        function addToPOReviewSKU(char) {
            currentPOReviewSKUInput += char;
            updatePOReviewSKUDisplay();
            checkForPOReviewMatches();
        }
        
        function backspacePOReviewSKU() {
            currentPOReviewSKUInput = currentPOReviewSKUInput.slice(0, -1);
            updatePOReviewSKUDisplay();
            checkForPOReviewMatches();
        }
        
        function clearPOReviewSKU() {
            currentPOReviewSKUInput = '';
            updatePOReviewSKUDisplay();
            document.getElementById('poReviewQuickMatchDropdown').style.display = 'none';
        }
        
        function updatePOReviewSKUDisplay() {
            document.getElementById('poReviewSkuTyped').textContent = currentPOReviewSKUInput || '';
        }
        
        function extractBrandPrefix(sku) {
            // Extract letters before first number or dash
            const match = sku.match(/^([A-Z]+)/i);
            return match ? match[1].toUpperCase() : '';
        }
        
        function checkForPOReviewMatches() {
            const dropdown = document.getElementById('poReviewQuickMatchDropdown');
            
            if (currentPOReviewSKUInput.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            let matches = inventory.filter(item => 
                item.sku.toUpperCase().includes(currentPOReviewSKUInput.toUpperCase())
            );
            
            // Apply brand filter if set
            if (poReviewSession && poReviewSession.brandFilter) {
                matches = matches.filter(item => {
                    const prefix = extractBrandPrefix(item.sku);
                    return prefix === poReviewSession.brandFilter;
                });
            }
            
            matches = matches.slice(0, 5);
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            let html = '<div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #64748b;">Quick Matches:</div>';
            matches.forEach(item => {
                const alreadyReviewed = poReviewedItems.find(r => r.sku === item.sku);
                const reviewedBadge = alreadyReviewed ? ' <span style="color: #10b981;">‚úì</span>' : '';
                
                const onOrder = currentPOList[item.sku] || 0;
                const onOrderBadge = onOrder > 0 ? ' <span style="color: #3b82f6;">üì¶ ' + onOrder + '</span>' : '';
                
                html += '<div style="padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="selectPOReviewSKU(\'' + item.sku + '\')">';
                html += '<div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">' + item.sku + reviewedBadge + onOrderBadge + '</div>';
                if (item.description) html += '<div style="font-size: 13px; color: #64748b;">' + item.description + '</div>';
                html += '</div>';
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        function selectPOReviewSKU(sku) {
            currentPOReviewSKUInput = '';
            updatePOReviewSKUDisplay();
            document.getElementById('poReviewQuickMatchDropdown').style.display = 'none';
            loadPOReviewItem(sku);
        }
        
        function startPOReviewSession() {
            const sessionName = document.getElementById('poReviewSessionName').value.trim() || 'PO Review';
            const brandFilter = document.getElementById('poReviewBrandFilter').value.trim().toUpperCase();
            const currentPOText = document.getElementById('poReviewCurrentPO').value.trim();
            
            // Parse current PO
            currentPOList = {};
            if (currentPOText) {
                const lines = currentPOText.split('\n');
                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 2) {
                        const sku = parts[0].toUpperCase();
                        const qty = parseInt(parts[1]) || 0;
                        if (sku && sku !== 'SKU') {
                            currentPOList[sku] = qty;
                        }
                    }
                });
            }
            
            poReviewSession = {
                id: Date.now(),
                name: sessionName,
                startTime: new Date().toISOString(),
                brandFilter: brandFilter || null,
                currentPO: currentPOList,
                items: []
            };
            
            poReviewedItems = [];
            
            document.getElementById('startPOReviewScreen').style.display = 'none';
            document.getElementById('poReviewSession').style.display = 'block';
            updatePOReviewProgress();
            showPOReviewKeyboard();
            
            const poCount = Object.keys(currentPOList).length;
            if (poCount > 0) {
                showNotification(poCount + ' items in current PO');
            }
        }
        
        function showPOReviewKeyboard() {
            document.getElementById('poReviewKeyboardScreen').style.display = 'block';
            document.getElementById('poReviewItemCard').style.display = 'none';
        }
        
        function loadPOReviewItem(sku) {
            const item = inventory.find(i => i.sku === sku);
            if (!item) {
                showNotification('SKU not found in inventory', 'error');
                return;
            }
            
            // Check if already reviewed
            const previousReview = poReviewedItems.find(r => r.sku === sku);
            
            document.getElementById('poReviewKeyboardScreen').style.display = 'none';
            document.getElementById('poReviewItemCard').style.display = 'block';
            
            document.getElementById('poReviewSKU').textContent = sku;
            document.getElementById('poReviewDescription').textContent = item.description || '-';
            
            // Show if on current PO
            const onOrder = currentPOList[sku] || 0;
            const badge = document.getElementById('poReviewOrderBadge');
            if (onOrder > 0) {
                badge.textContent = 'üì¶ ON ORDER: ' + onOrder + ' units';
                badge.style.background = '#dbeafe';
                badge.style.color = '#1e40af';
                badge.style.display = 'inline-block';
            } else {
                badge.textContent = '‚ö†Ô∏è NOT ON ORDER';
                badge.style.background = '#fef3c7';
                badge.style.color = '#92400e';
                badge.style.display = 'inline-block';
            }
            
            // Set values from previous review or defaults
            if (previousReview) {
                document.getElementById('poShelfQty').value = previousReview.shelfQty;
                document.getElementById('poMinStock').value = previousReview.minStock;
                document.getElementById('poMaxStock').value = previousReview.maxStock;
                document.getElementById('poOrderQty').value = previousReview.orderQty;
            } else {
                document.getElementById('poShelfQty').value = item.qtyOnHand || 0;
                document.getElementById('poMinStock').value = item.stockMin || '';
                document.getElementById('poMaxStock').value = item.stockMax || '';
                document.getElementById('poOrderQty').value = 0;
            }
            
            updatePOCalculation();
        }
        
        function updatePOCalculation() {
            const sku = document.getElementById('poReviewSKU').textContent;
            const shelfQty = parseInt(document.getElementById('poShelfQty').value) || 0;
            const minStock = parseInt(document.getElementById('poMinStock').value) || 0;
            const maxStock = parseInt(document.getElementById('poMaxStock').value) || 0;
            const onOrder = currentPOList[sku] || 0;
            const orderQty = parseInt(document.getElementById('poOrderQty').value) || 0;
            
            const totalOnOrder = onOrder + orderQty;
            const stockAfterDelivery = shelfQty + totalOnOrder;
            
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
            html += '<div><strong>On Shelf:</strong> ' + shelfQty + '</div>';
            html += '<div><strong>Total on Order:</strong> ' + totalOnOrder + '</div>';
            html += '<div><strong>After Delivery:</strong> ' + stockAfterDelivery + '</div>';
            
            if (minStock > 0 && maxStock > 0) {
                if (stockAfterDelivery < minStock) {
                    html += '<div style="color: #ef4444;"><strong>Status:</strong> Below Min</div>';
                } else if (stockAfterDelivery > maxStock) {
                    html += '<div style="color: #f59e0b;"><strong>Status:</strong> Above Max</div>';
                } else {
                    html += '<div style="color: #10b981;"><strong>Status:</strong> Good</div>';
                }
            }
            
            html += '</div>';
            
            document.getElementById('poCalculation').innerHTML = html;
        }
        
        async function savePOReviewItem() {
            const sku = document.getElementById('poReviewSKU').textContent;
            const shelfQty = parseInt(document.getElementById('poShelfQty').value) || 0;
            const minStock = parseInt(document.getElementById('poMinStock').value) || 0;
            const maxStock = parseInt(document.getElementById('poMaxStock').value) || 0;
            const orderQty = parseInt(document.getElementById('poOrderQty').value) || 0;
            const onOrder = currentPOList[sku] || 0;
            
            const item = inventory.find(i => i.sku === sku);
            
            // Remove if already reviewed
            poReviewedItems = poReviewedItems.filter(r => r.sku !== sku);
            
            const reviewRecord = {
                sku: sku,
                description: item.description,
                shelfQty: shelfQty,
                minStock: minStock,
                maxStock: maxStock,
                alreadyOnOrder: onOrder,
                orderQty: orderQty,
                totalOrder: onOrder + orderQty,
                reviewedAt: new Date().toISOString()
            };
            
            poReviewedItems.push(reviewRecord);
            poReviewSession.items = poReviewedItems;
            
            // Update inventory min/max in database
            try {
                await db.from('inventory').update({
                    stock_min: minStock,
                    stock_max: maxStock,
                    updated_at: new Date().toISOString()
                }).eq('sku', sku);
                
                // Update local inventory
                if (item) {
                    item.stockMin = minStock;
                    item.stockMax = maxStock;
                }
            } catch (e) {
                console.error('Error updating min/max:', e);
            }
            
            updatePOReviewProgress();
            showPOReviewKeyboard();
            showNotification('‚úì ' + sku + ' reviewed');
        }
        
        function updatePOReviewProgress() {
            const orderCount = poReviewedItems.filter(i => i.orderQty > 0).length;
            
            document.getElementById('poReviewProgress').textContent = poReviewedItems.length;
            document.getElementById('poReviewOrderCount').textContent = orderCount;
        }
        
        function finishPOReviewSession() {
            if (!poReviewSession || poReviewedItems.length === 0) {
                showNotification('No items reviewed', 'error');
                return;
            }
            
            poReviewSession.endTime = new Date().toISOString();
            poReviewSession.completed = true;
            
            const orderCount = poReviewedItems.filter(i => i.orderQty > 0).length;
            
            poReviewSession.summary = {
                total: poReviewedItems.length,
                toOrder: orderCount
            };
            
            // Export immediately
            exportPOReviewSession();
            
            document.getElementById('poReviewSession').style.display = 'none';
            document.getElementById('startPOReviewScreen').style.display = 'block';
            document.getElementById('poReviewSessionName').value = '';
            document.getElementById('poReviewBrandFilter').value = '';
            document.getElementById('poReviewCurrentPO').value = '';
            
            showNotification('PO Review complete! ' + orderCount + ' items to order');
            
            poReviewSession = null;
            poReviewedItems = [];
            currentPOList = {};
        }
        
        function exportPOReviewSession() {
            const session = poReviewSession;
            let csv = 'PO Review Report\n';
            csv += 'Session: ' + session.name + '\n';
            csv += 'Date: ' + new Date(session.startTime).toLocaleString() + '\n';
            if (session.brandFilter) csv += 'Brand Filter: ' + session.brandFilter + '\n';
            csv += '\n';
            csv += 'SKU,Description,Shelf Qty,Min,Max,Already on Order,Add to Order,Total Order,Reviewed At\n';
            
            session.items.forEach(item => {
                csv += '"' + item.sku + '","' + (item.description || '') + '",';
                csv += item.shelfQty + ',' + item.minStock + ',' + item.maxStock + ',';
                csv += item.alreadyOnOrder + ',' + item.orderQty + ',' + item.totalOrder + ',';
                csv += '"' + new Date(item.reviewedAt).toLocaleString() + '"\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'PO_Review_' + session.name.replace(/\s+/g, '_') + '_' + new Date(session.startTime).toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Count Sessions Sync Functions
        async function saveCountSessionToDatabase(session) {
            try {
                const sessionData = {
                    id: session.id,
                    name: session.name,
                    session_type: session.sortOrder ? 'physical_count' : (session.returnList ? 'audit' : (session.brandFilter !== undefined ? 'po_review' : 'manual_count')),
                    start_time: session.startTime,
                    end_time: session.endTime || null,
                    completed: session.completed || false,
                    sort_order: session.sortOrder || null,
                    location_filter: session.locationFilter || null,
                    brand_filter: session.brandFilter || null,
                    session_data: session
                };
                
                const { error } = await db.from('count_sessions').upsert(sessionData, { onConflict: 'id' });
                if (error) {
                    console.error('Error saving count session:', error);
                    localStorage.setItem('countSessions', JSON.stringify(countSessions));
                }
            } catch (e) {
                console.error('Error syncing count session:', e);
                localStorage.setItem('countSessions', JSON.stringify(countSessions));
            }
        }
        
        async function loadCountSessionsFromDatabase() {
            try {
                const { data, error} = await db
                    .from('count_sessions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    countSessions = data.map(row => row.session_data);
                    localStorage.setItem('countSessions', JSON.stringify(countSessions));
                    return true;
                } else {
                    const savedSessions = localStorage.getItem('countSessions');
                    if (savedSessions) {
                        countSessions = JSON.parse(savedSessions);
                    }
                    return false;
                }
            } catch (e) {
                console.error('Error loading count sessions:', e);
                const savedSessions = localStorage.getItem('countSessions');
                if (savedSessions) {
                    countSessions = JSON.parse(savedSessions);
                }
                return false;
            }
        }

        // Stock Entry
        let stockEntrySessionCount = 0;
        let ghLastUsedSuffix = localStorage.getItem('ghLastSuffix') || 'MB';
        let lastUsedFormat = localStorage.getItem('skuFormat') || 'manual';

        // All wizard form IDs
        const ALL_FORMS = {
            manual: 'manualEntryForm',
            GH:     'ghEntryForm',
            GHA:    'ghaEntryForm',
            MH:     'mhEntryForm',
            MW:     'mwEntryForm',
            FDP:    'fdpEntryForm'
        };

        function switchSKUFormat(format) {
            // Hide all forms
            Object.values(ALL_FORMS).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            // Show selected
            const target = ALL_FORMS[format] || ALL_FORMS.manual;
            const el = document.getElementById(target);
            if (el) el.style.display = 'block';

            if (format === 'GH') {
                document.getElementById('ghSuffix').value = ghLastUsedSuffix;
                updateGHPreview();
            }
            if (format === 'GHA') {
                ghaUpdatePreview();
            }
            if (format === 'MH') mhUpdatePreview();
            if (format === 'MW') mwUpdatePreview();
            if (format === 'FDP') fdpUpdatePreview();

            lastUsedFormat = format;
            localStorage.setItem('skuFormat', format);
        }

        // ---- Shared helper: adjust qty for any wizard ----
        function adjustWizardQty(fieldId, delta) {
            const input = document.getElementById(fieldId);
            if (!input) return;
            input.value = Math.max(0, (parseInt(input.value) || 0) + delta);
        }

        // ---- Shared save helper ----
        async function saveWizardEntry(sku, qohId, minId, maxId, locationId, clearFn) {
            if (!sku) { showNotification('SKU is required', 'error'); return; }
            const qoh      = parseInt(document.getElementById(qohId).value) || 0;
            const minVal   = document.getElementById(minId).value !== '' ? parseInt(document.getElementById(minId).value) : null;
            const maxVal   = document.getElementById(maxId).value !== '' ? parseInt(document.getElementById(maxId).value) : null;
            const location = document.getElementById(locationId).value.trim().toUpperCase();
            try {
                showLoading(true, 'Saving...');
                const { error } = await db.from('inventory').upsert({
                    sku, qty_on_hand: qoh, stock_min: minVal, stock_max: maxVal,
                    location, updated_at: new Date().toISOString()
                }, { onConflict: 'sku' });
                if (error) throw error;
                await loadInventory();
                stockEntrySessionCount++;
                const countEl = document.getElementById('stockEntryCount');
                if (countEl) countEl.textContent = stockEntrySessionCount;
                const lastSaved = document.getElementById('stockEntryLastSaved');
                if (lastSaved) {
                    lastSaved.textContent = '‚úì Saved: ' + sku + '  (QOH: ' + qoh + ')';
                    lastSaved.style.display = 'block';
                }
                showNotification('‚úì Saved: ' + sku);
                clearFn();
            } catch(e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ============================================================
        //  Debounce utility - delays expensive checks until typing stops
        // ============================================================
        function debounce(fn, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // ============================================================
        //  GHA ‚Äî Gates Adapter Fittings
        // ============================================================

        function ghaAutoFormat(input) {
            let raw = input.value.replace(/^GHA/i, '').replace(/-/g, '').replace(/[^0-9]/g, '').slice(0, 8);
            let formatted = '';
            if (raw.length <= 4)      formatted = raw;
            else if (raw.length <= 6) formatted = raw.slice(0,4) + '-' + raw.slice(4);
            else                      formatted = raw.slice(0,4) + '-' + raw.slice(4,6) + '-' + raw.slice(6);
            input.value = formatted;
            ghaUpdatePreview();
        }

        function ghaGetSKU() {
            const val = document.getElementById('ghaRawInput').value.trim();
            return val ? 'GHA' + val : '';
        }

        function ghaUpdatePreview() {
            const sku = ghaGetSKU();
            document.getElementById('ghaSKUPreview').textContent = sku || 'GHA____-__-__';
        }

        function ghaCheckExists() {
            const sku = ghaGetSKU();
            if (!sku) { document.getElementById('ghaSkuWarning').style.display = 'none'; return; }
            const existing = inventory.find(i => i.sku === sku);
            document.getElementById('ghaSkuWarning').style.display = existing ? 'block' : 'none';
            if (existing) {
                document.getElementById('ghaQOH').value      = existing.qtyOnHand || 0;
                document.getElementById('ghaMIN').value      = existing.stockMin || '';
                document.getElementById('ghaMAX').value      = existing.stockMax || '';
                document.getElementById('ghaLocation').value = existing.location || '';
            }
        }

        async function saveGHAEntry() {
            const sku = ghaGetSKU();
            if (!sku || sku.replace(/[^0-9]/g,'').length < 8) {
                showNotification('Please enter all 8 digits', 'error'); return;
            }
            await saveWizardEntry(sku, 'ghaQOH', 'ghaMIN', 'ghaMAX', 'ghaLocation', () => {
                document.getElementById('ghaRawInput').value = '';
                document.getElementById('ghaQOH').value      = '0';
                document.getElementById('ghaSkuWarning').style.display = 'none';
                ghaUpdatePreview();
                document.getElementById('ghaRawInput').focus();
            });
        }
        // ============================================================
        //  MH ‚Äî McHale
        // ============================================================
        function mhUpdatePreview() {
            const letters  = document.getElementById('mhLetters').value.toUpperCase() || '___';
            const numbers  = document.getElementById('mhNumbers').value || '00000';
            document.getElementById('mhSKUPreview').textContent = 'MH-' + letters + numbers;
        }

        function mhCheckExists() {
            const letters = document.getElementById('mhLetters').value.trim().toUpperCase();
            const numbers = document.getElementById('mhNumbers').value.trim();
            if (!letters || !numbers) { document.getElementById('mhSkuWarning').style.display = 'none'; return; }
            const sku = 'MH-' + letters + numbers;
            const existing = inventory.find(i => i.sku === sku);
            document.getElementById('mhSkuWarning').style.display = existing ? 'block' : 'none';
            if (existing) {
                document.getElementById('mhQOH').value = existing.qtyOnHand || 0;
                document.getElementById('mhMIN').value = existing.stockMin || '';
                document.getElementById('mhMAX').value = existing.stockMax || '';
                document.getElementById('mhLocation').value = existing.location || '';
            }
        }

        async function saveMHEntry() {
            const letters = document.getElementById('mhLetters').value.trim().toUpperCase();
            const numbers = document.getElementById('mhNumbers').value.trim();
            if (!letters || letters.length !== 3) { showNotification('Enter exactly 3 letters', 'error'); return; }
            if (!numbers || numbers.length !== 5)  { showNotification('Enter exactly 5 numbers', 'error'); return; }
            const sku = 'MH-' + letters + numbers;
            await saveWizardEntry(sku, 'mhQOH', 'mhMIN', 'mhMAX', 'mhLocation', () => {
                document.getElementById('mhLetters').value = '';
                document.getElementById('mhNumbers').value = '';
                document.getElementById('mhQOH').value     = '0';
                document.getElementById('mhSkuWarning').style.display = 'none';
                mhUpdatePreview();
                document.getElementById('mhLetters').focus();
            });
        }

        // ============================================================
        //  MW ‚Äî Martin Welding
        // ============================================================
        function mwAutoFormat(input) {
            // Strip MW prefix if user typed it, strip all dashes, uppercase
            let raw = input.value.replace(/^MW/i, '').replace(/-/g, '').toUpperCase();
            // Separate digits from trailing letters
            const digitMatch = raw.match(/^(\d{0,12})(.*)/);
            const digits  = digitMatch ? digitMatch[1] : '';
            const letters = digitMatch ? digitMatch[2] : '';
            // Insert dashes at positions 4 and 8 within the digits
            let formatted = '';
            if (digits.length <= 4)       formatted = digits;
            else if (digits.length <= 8)  formatted = digits.slice(0,4) + '-' + digits.slice(4);
            else                          formatted = digits.slice(0,4) + '-' + digits.slice(4,8) + '-' + digits.slice(8);
            // Append any letters (suffix)
            input.value = formatted + letters;
            mwUpdatePreview();
        }

        function mwGetSKU() {
            const val = document.getElementById('mwRawInput').value.trim().toUpperCase();
            return val ? 'MW' + val : '';
        }

        function mwUpdatePreview() {
            const sku = mwGetSKU();
            document.getElementById('mwSKUPreview').textContent = sku || 'MW____-____-___';
        }

        function mwCheckExists() {
            const sku = mwGetSKU();
            if (!sku) { document.getElementById('mwSkuWarning').style.display = 'none'; return; }
            const existing = inventory.find(i => i.sku === sku);
            document.getElementById('mwSkuWarning').style.display = existing ? 'block' : 'none';
            if (existing) {
                document.getElementById('mwQOH').value = existing.qtyOnHand || 0;
                document.getElementById('mwMIN').value = existing.stockMin || '';
                document.getElementById('mwMAX').value = existing.stockMax || '';
                document.getElementById('mwLocation').value = existing.location || '';
            }
        }

        async function saveMWEntry() {
            const sku = mwGetSKU();
            if (!sku || sku.length < 6) { showNotification('Please enter the part number', 'error'); return; }
            await saveWizardEntry(sku, 'mwQOH', 'mwMIN', 'mwMAX', 'mwLocation', () => {
                document.getElementById('mwRawInput').value = '';
                document.getElementById('mwQOH').value      = '0';
                document.getElementById('mwSkuWarning').style.display = 'none';
                mwUpdatePreview();
                document.getElementById('mwRawInput').focus();
            });
        }

        // ============================================================
        //  FDP ‚Äî Donaldson
        // ============================================================
        function fdpUpdatePreview() {
            const nums = document.getElementById('fdpNumbers').value || '______';
            document.getElementById('fdpSKUPreview').textContent = 'FDP' + nums;
        }

        function fdpCheckExists() {
            const nums = document.getElementById('fdpNumbers').value.trim();
            if (!nums) { document.getElementById('fdpSkuWarning').style.display = 'none'; return; }
            const sku = 'FDP' + nums;
            const existing = inventory.find(i => i.sku === sku);
            document.getElementById('fdpSkuWarning').style.display = existing ? 'block' : 'none';
            if (existing) {
                document.getElementById('fdpQOH').value = existing.qtyOnHand || 0;
                document.getElementById('fdpMIN').value = existing.stockMin || '';
                document.getElementById('fdpMAX').value = existing.stockMax || '';
                document.getElementById('fdpLocation').value = existing.location || '';
            }
        }

        async function saveFDPEntry() {
            const nums = document.getElementById('fdpNumbers').value.trim();
            if (!nums) { showNotification('Please enter the part number', 'error'); return; }
            const sku = 'FDP' + nums;
            await saveWizardEntry(sku, 'fdpQOH', 'fdpMIN', 'fdpMAX', 'fdpLocation', () => {
                document.getElementById('fdpNumbers').value = '';
                document.getElementById('fdpQOH').value     = '0';
                document.getElementById('fdpSkuWarning').style.display = 'none';
                fdpUpdatePreview();
                document.getElementById('fdpNumbers').focus();
            });
        }

        function updateGHPreview() {
            const first = document.getElementById('ghFirstNum').value || '__';
            const second = document.getElementById('ghSecondNum').value || '__';
            const suffix = document.getElementById('ghSuffix').value;
            
            const preview = 'GH' + first + 'G-' + second + suffix;
            document.getElementById('ghSKUPreview').textContent = preview;
            
            // Save last used suffix
            ghLastUsedSuffix = suffix;
            localStorage.setItem('ghLastSuffix', suffix);
        }

        function checkGHExists() {
            const first = document.getElementById('ghFirstNum').value.trim();
            const second = document.getElementById('ghSecondNum').value.trim();
            const suffix = document.getElementById('ghSuffix').value;
            
            if (!first || !second) {
                document.getElementById('ghSkuWarning').style.display = 'none';
                return;
            }
            
            const sku = 'GH' + first + 'G-' + second + suffix;
            const existing = inventory.find(i => i.sku === sku);
            
            if (existing) {
                document.getElementById('ghSkuWarning').style.display = 'block';
                // Pre-fill existing values
                document.getElementById('ghQOH').value = existing.qtyOnHand || 0;
                document.getElementById('ghMIN').value = existing.stockMin || '';
                document.getElementById('ghMAX').value = existing.stockMax || '';
                document.getElementById('ghLocation').value = existing.location || '';
            } else {
                document.getElementById('ghSkuWarning').style.display = 'none';
            }
        }

        function adjustGHQty(field, delta) {
            const ids = { qoh: 'ghQOH', min: 'ghMIN', max: 'ghMAX' };
            const input = document.getElementById(ids[field]);
            const current = parseInt(input.value) || 0;
            const newVal = Math.max(0, current + delta);
            input.value = newVal;
        }

        async function saveGHEntry() {
            const first = document.getElementById('ghFirstNum').value.trim();
            const second = document.getElementById('ghSecondNum').value.trim();
            
            if (!first || !second) {
                showNotification('Please enter both numbers', 'error');
                return;
            }

            const suffix = document.getElementById('ghSuffix').value;
            const sku = 'GH' + first + 'G-' + second + suffix;
            const qoh = parseInt(document.getElementById('ghQOH').value) || 0;
            const min = document.getElementById('ghMIN').value !== '' ? parseInt(document.getElementById('ghMIN').value) : null;
            const max = document.getElementById('ghMAX').value !== '' ? parseInt(document.getElementById('ghMAX').value) : null;
            const location = document.getElementById('ghLocation').value.trim().toUpperCase();

            const btn = document.getElementById('btnSaveGH');
            if (!btn) return;
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            try {
                const { error } = await db.from('inventory').upsert({
                    sku,
                    qty_on_hand: qoh,
                    stock_min: min,
                    stock_max: max,
                    location: location,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'sku' });

                if (error) throw error;

                console.log('GH Save successful, starting cleanup...');

                await loadInventory();

                console.log('GH Inventory reloaded');

                stockEntrySessionCount++;
                console.log('GH Session count:', stockEntrySessionCount);
                const countEl = document.getElementById('stockEntryCount');
                if (countEl) {
                    countEl.textContent = stockEntrySessionCount;
                    console.log('GH Counter updated');
                } else {
                    console.error('GH stockEntryCount element not found!');
                }

                const lastSaved = document.getElementById('stockEntryLastSaved');
                if (lastSaved) {
                    lastSaved.textContent = '‚úì Saved: ' + sku + '  (QOH: ' + qoh + (min !== null ? '  Min: ' + min : '') + (max !== null ? '  Max: ' + max : '') + (location ? '  üìç ' + location : '') + ')';
                    lastSaved.style.display = 'block';
                    console.log('GH Confirmation shown');
                } else {
                    console.error('GH stockEntryLastSaved element not found!');
                }

                // Clear first and second numbers only (keep suffix, QOH starts at 0, keep min/max, keep location)
                console.log('GH Clearing number fields...');
                document.getElementById('ghFirstNum').value = '';
                document.getElementById('ghSecondNum').value = '';
                document.getElementById('ghQOH').value = '0';
                console.log('GH Fields cleared');
                // Don't clear: suffix, min, max, location
                
                updateGHPreview();
                
                setTimeout(() => {
                    document.getElementById('ghFirstNum').focus();
                    console.log('GH First number focused');
                }, 100);

            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                if (btn) {
                    btn.innerHTML = '‚úì Save &amp; New';
                    btn.disabled = false;
                }
            }
        }

        function adjustEntryQty(field, delta) {
            const ids = { qoh: 'entryQOH', min: 'entryMIN', max: 'entryMAX' };
            const input = document.getElementById(ids[field]);
            const current = parseInt(input.value) || 0;
            const newVal = Math.max(0, current + delta);
            input.value = newVal;
        }

        function checkExistingSKU(sku) {
            const existing = inventory.find(i => i.sku === sku.trim().toUpperCase());
            const warning = document.getElementById('entrySkuWarning');
            if (existing) {
                warning.style.display = 'block';
                document.getElementById('entryQOH').value = existing.qtyOnHand || 0;
                document.getElementById('entryMIN').value = existing.stockMin || '';
                document.getElementById('entryMAX').value = existing.stockMax || '';
                document.getElementById('entryLocation').value = existing.location || '';
            } else {
                warning.style.display = 'none';
            }
        }

        async function saveStockEntry() {
            const sku = document.getElementById('entrySKU').value.trim().toUpperCase();
            if (!sku) {
                showNotification('SKU is required', 'error');
                document.getElementById('entrySKU').focus();
                return;
            }

            const qoh = parseInt(document.getElementById('entryQOH').value) || 0;
            const min = document.getElementById('entryMIN').value !== '' ? parseInt(document.getElementById('entryMIN').value) : null;
            const max = document.getElementById('entryMAX').value !== '' ? parseInt(document.getElementById('entryMAX').value) : null;
            const location = document.getElementById('entryLocation').value.trim().toUpperCase();

            const btn = document.getElementById('btnSaveEntry');
            if (!btn) {
                console.error('Save button not found!');
                return;
            }
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            try {
                const { error } = await db.from('inventory').upsert({
                    sku,
                    qty_on_hand: qoh,
                    stock_min: min,
                    stock_max: max,
                    location: location,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'sku' });

                if (error) throw error;

                console.log('Save successful, starting cleanup...');

                // Update local inventory
                await loadInventory();

                console.log('Inventory reloaded');

                // Show confirmation
                stockEntrySessionCount++;
                console.log('Session count:', stockEntrySessionCount);
                const countEl = document.getElementById('stockEntryCount');
                if (countEl) {
                    countEl.textContent = stockEntrySessionCount;
                    console.log('Counter updated');
                } else {
                    console.error('stockEntryCount element not found!');
                }

                const lastSaved = document.getElementById('stockEntryLastSaved');
                if (lastSaved) {
                    lastSaved.textContent = '‚úì Saved: ' + sku + '  (QOH: ' + qoh + (min !== null ? '  Min: ' + min : '') + (max !== null ? '  Max: ' + max : '') + (location ? '  üìç ' + location : '') + ')';
                    lastSaved.style.display = 'block';
                    console.log('Confirmation shown');
                } else {
                    console.error('stockEntryLastSaved element not found!');
                }

                // Clear for next entry
                console.log('Clearing fields...');
                const skuField = document.getElementById('entrySKU');
                const qohField = document.getElementById('entryQOH');
                const minField = document.getElementById('entryMIN');
                const maxField = document.getElementById('entryMAX');
                const locField = document.getElementById('entryLocation');
                const warnField = document.getElementById('entrySkuWarning');
                
                console.log('Fields found:', {sku: !!skuField, qoh: !!qohField, min: !!minField, max: !!maxField, loc: !!locField});
                
                if (skuField) {
                    skuField.value = '';
                    console.log('SKU cleared, value is now:', skuField.value);
                }
                if (qohField) {
                    qohField.value = '0';
                    console.log('QOH cleared, value is now:', qohField.value);
                }
                if (minField) minField.value = '';
                if (maxField) maxField.value = '';
                if (locField) locField.value = '';
                if (warnField) warnField.style.display = 'none';

                console.log('All fields cleared');

                // Focus SKU field for next entry
                setTimeout(() => {
                    if (skuField) skuField.focus();
                    console.log('SKU field focused');
                }, 200);

            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                if (btn) {
                    btn.innerHTML = '‚úì Save &amp; New';
                    btn.disabled = false;
                }
            }
        }

        // ============================================================
        //  QB RECONCILE - Full Feature
        // ============================================================

        let qbCurrentSession = null;       // session object in memory
        let qbCurrentFilter  = 'all';      // 'all' | 'pending' | 'ok' | 'diff'
        let qbVerifyingSKU   = null;       // sku currently open in verify card

        // ---- Supabase helpers ----
        async function qbSaveSessionToCloud(session) {
            const payload = {
                session_id:   session.id,
                session_name: session.name,
                created_at:   session.createdAt,
                status:       session.status,
                items:        JSON.stringify(session.items)
            };
            const { error } = await db
                .from('qb_reconcile_sessions')
                .upsert(payload, { onConflict: 'session_id' });
            if (error) console.error('QB cloud save error:', error.message);
        }

        async function qbLoadSessionsFromCloud() {
            try {
                const { data, error } = await db
                    .from('qb_reconcile_sessions')
                    .select('*')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                return (data || []).map(row => ({
                    id:        row.session_id,
                    name:      row.session_name,
                    createdAt: row.created_at,
                    status:    row.status,
                    items:     JSON.parse(row.items || '[]')
                }));
            } catch (e) {
                console.error('QB load sessions error:', e.message);
                return [];
            }
        }

        async function qbMarkSessionFinished(sessionId) {
            const { error } = await db
                .from('qb_reconcile_sessions')
                .update({ status: 'finished' })
                .eq('session_id', sessionId);
            if (error) console.error('QB finish error:', error.message);
        }

        // ---- Called when QB Reconcile tab is opened ----
        async function qbInitTab() {
            showLoading(true, 'Loading reconcile sessions...');
            try {
                const sessions = await qbLoadSessionsFromCloud();
                const area = document.getElementById('qbActiveSessionsArea');
                const list = document.getElementById('qbActiveSessionsList');

                if (sessions.length > 0) {
                    area.style.display = 'block';
                    let html = '';
                    sessions.forEach(s => {
                        const total    = s.items.length;
                        const verified = s.items.filter(i => i.verified).length;
                        const diff     = s.items.filter(i => i.verified && i.variance !== 0).length;
                        html += `<div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 14px; margin-bottom: 10px; background: #f8fafc;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <div style="font-weight:700; font-size:15px; color:#1e293b;">${s.name}</div>
                                <div style="font-size:12px; color:#64748b;">${new Date(s.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div style="font-size:13px; color:#64748b; margin-bottom:10px;">
                                ${verified}/${total} verified &nbsp;|&nbsp; <span style="color:#ef4444;">${diff} discrepancies</span>
                            </div>
                            <button onclick="qbResumeSession('${s.id}')" style="width:100%; padding:10px; border:none; border-radius:8px; font-size:14px; font-weight:700; cursor:pointer; background:#f59e0b; color:white;">‚ñ∂ Resume Session</button>
                        </div>`;
                    });
                    list.innerHTML = html;
                } else {
                    area.style.display = 'none';
                }
            } catch(e) {
                console.error('qbInitTab error:', e);
            } finally {
                showLoading(false);
            }
        }

        async function qbResumeSession(sessionId) {
            showLoading(true, 'Loading session...');
            try {
                const sessions = await qbLoadSessionsFromCloud();
                const session  = sessions.find(s => s.id === sessionId);
                if (!session) { showNotification('Session not found', 'error'); return; }
                qbCurrentSession = session;
                qbShowSessionScreen();
            } catch(e) {
                showNotification('Error loading session: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ---- File upload handler ----
        function qbHandleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('qbCSVPaste').value = e.target.result;
                document.getElementById('qbFileStatus').style.display = 'block';
                document.getElementById('qbFileStatus').textContent = '‚úì File loaded: ' + file.name;
            };
            reader.readAsText(file);
        }

        // ---- Parse QB CSV ----
        function qbParseCSV(text) {
            const lines = text.trim().split('\n');
            const items = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                // Skip header row
                if (i === 0 && (line.toLowerCase().includes('sku') || line.toLowerCase().includes('item'))) continue;
                const parts = line.split(',').map(p => p.trim().replace(/^["']|["']$/g, ''));
                if (parts.length < 2) continue;

                // Support both "SKU,Qty" and "SKU,Description,Qty"
                let sku, qbQty;
                if (parts.length === 2) {
                    // Simple 2-column format: SKU, Qty
                    sku   = parts[0].toUpperCase();
                    qbQty = parseInt(parts[1]) || 0;
                } else {
                    // 3+ column format: SKU, Description, Qty
                    sku   = parts[0].toUpperCase();
                    qbQty = parseInt(parts[2]) || 0;
                }

                if (!sku) continue;

                // Pull description and location from InvenTrack
                const invItem = inventory.find(i => i.sku === sku);
                items.push({
                    sku:         sku,
                    description: invItem ? (invItem.description || '') : '',
                    qbQty:       qbQty,
                    itQty:       invItem ? (invItem.qtyOnHand || 0) : null,
                    location:    invItem ? (invItem.location || '') : '',
                    verified:    false,
                    actualQty:   null,
                    variance:    null,
                    notes:       '',
                    verifiedAt:  null
                });
            }
            return items;
        }

        // ---- Start new session ----
        async function qbStartSession() {
            const csvText = document.getElementById('qbCSVPaste').value.trim();
            if (!csvText) {
                showNotification('Please upload or paste a CSV first', 'error');
                return;
            }
            const sessionName = document.getElementById('qbSessionName').value.trim() || ('QB Reconcile ' + new Date().toLocaleDateString());
            const items = qbParseCSV(csvText);
            if (items.length === 0) {
                showNotification('No valid items found in CSV', 'error');
                return;
            }

            qbCurrentSession = {
                id:        'qb_' + Date.now(),
                name:      sessionName,
                createdAt: new Date().toISOString(),
                status:    'active',
                items:     items
            };

            showLoading(true, 'Saving session to cloud...');
            try {
                await qbSaveSessionToCloud(qbCurrentSession);
                qbShowSessionScreen();
                showNotification('Session started! ' + items.length + ' items loaded.');
            } catch(e) {
                showNotification('Error saving session: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function qbShowSessionScreen() {
            document.getElementById('qbUploadScreen').style.display   = 'none';
            document.getElementById('qbSessionScreen').style.display  = 'block';
            document.getElementById('qbResultsScreen').style.display  = 'none';
            document.getElementById('qbActiveSessionName').textContent = qbCurrentSession.name;
            qbCurrentFilter = 'all';
            qbUpdateFilterButtons();
            qbUpdateProgress();
            qbRenderList();
        }

        // ---- Filter buttons ----
        function qbSetFilter(f) {
            qbCurrentFilter = f;
            qbUpdateFilterButtons();
            qbRenderList();
        }

        function qbUpdateFilterButtons() {
            ['all','pending','ok','diff'].forEach(f => {
                const btn = document.getElementById('qbFilter' + f.charAt(0).toUpperCase() + f.slice(1));
                if (!btn) return;
                const active = f === qbCurrentFilter;
                btn.style.background    = active ? '#3b82f6' : 'white';
                btn.style.color         = active ? 'white' : '#64748b';
                btn.style.borderColor   = active ? '#3b82f6' : '#e2e8f0';
            });
        }

        // ---- Progress ----
        function qbUpdateProgress() {
            if (!qbCurrentSession) return;
            const items      = qbCurrentSession.items;
            const total      = items.length;
            const verified   = items.filter(i => i.verified).length;
            const discrepant = items.filter(i => i.verified && i.variance !== 0).length;
            const pct        = total > 0 ? (verified / total) * 100 : 0;

            document.getElementById('qbVerifiedCount').textContent    = verified;
            document.getElementById('qbTotalCount').textContent       = total;
            document.getElementById('qbDiscrepancyCount').textContent = discrepant;
            document.getElementById('qbProgressBar').style.width      = pct + '%';
        }

        // ---- Render item list ----
        function qbRenderList() {
            if (!qbCurrentSession) return;
            const search = (document.getElementById('qbSearchBox').value || '').toLowerCase();
            let items    = qbCurrentSession.items;

            // Apply filter
            if (qbCurrentFilter === 'pending') items = items.filter(i => !i.verified);
            if (qbCurrentFilter === 'ok')      items = items.filter(i => i.verified && i.variance === 0);
            if (qbCurrentFilter === 'diff')    items = items.filter(i => i.verified && i.variance !== 0);

            // Apply search
            if (search) {
                items = items.filter(i =>
                    i.sku.toLowerCase().includes(search) ||
                    (i.description && i.description.toLowerCase().includes(search))
                );
            }

            const container = document.getElementById('qbItemList');
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">No items match the current filter</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                // Determine status color/label
                let statusBg, statusColor, statusLabel;
                if (!item.verified) {
                    statusBg = '#f1f5f9'; statusColor = '#64748b'; statusLabel = 'Pending';
                } else if (item.variance === 0) {
                    statusBg = '#d1fae5'; statusColor = '#065f46'; statusLabel = '‚úì Match';
                } else {
                    statusBg = '#fee2e2'; statusColor = '#991b1b'; statusLabel = '‚ö†Ô∏è Diff';
                }

                const itDisplay  = item.itQty !== null ? item.itQty : '‚Äî';
                const varDisplay = item.verified ? ((item.variance > 0 ? '+' : '') + item.variance) : '‚Äî';

                html += `<div onclick="qbOpenVerify('${item.sku}')" style="background:white; padding:14px 16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:10px; cursor:pointer; border-left: 4px solid ${item.verified ? (item.variance === 0 ? '#10b981' : '#ef4444') : '#e2e8f0'};">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:6px;">
                        <div>
                            <div style="font-size:16px; font-weight:700; color:#1e293b;">${item.sku}</div>
                            <div style="font-size:13px; color:#64748b;">${item.description || '‚Äî'}</div>
                            ${item.location ? `<div style="font-size:12px; color:#94a3b8; margin-top:2px;">üìç ${item.location}</div>` : ''}
                        </div>
                        <span style="padding:4px 10px; border-radius:20px; font-size:12px; font-weight:700; background:${statusBg}; color:${statusColor}; white-space:nowrap; margin-left:8px;">${statusLabel}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px;">
                        <div style="background:#fef9c3; padding:8px; border-radius:6px; text-align:center;">
                            <div style="font-size:10px; font-weight:700; color:#713f12; margin-bottom:2px;">QB QTY</div>
                            <div style="font-size:18px; font-weight:800; color:#713f12;">${item.qbQty}</div>
                        </div>
                        <div style="background:#dbeafe; padding:8px; border-radius:6px; text-align:center;">
                            <div style="font-size:10px; font-weight:700; color:#1e40af; margin-bottom:2px;">INVEN QTY</div>
                            <div style="font-size:18px; font-weight:800; color:#1e40af;">${itDisplay}</div>
                        </div>
                        <div style="background:${item.verified ? (item.variance === 0 ? '#d1fae5' : '#fee2e2') : '#f1f5f9'}; padding:8px; border-radius:6px; text-align:center;">
                            <div style="font-size:10px; font-weight:700; color:${item.verified ? (item.variance === 0 ? '#065f46' : '#991b1b') : '#64748b'}; margin-bottom:2px;">VARIANCE</div>
                            <div style="font-size:18px; font-weight:800; color:${item.verified ? (item.variance === 0 ? '#065f46' : '#991b1b') : '#64748b'};">${varDisplay}</div>
                        </div>
                    </div>
                    ${item.notes ? `<div style="margin-top:8px; font-size:12px; color:#64748b; font-style:italic;">üìù ${item.notes}</div>` : ''}
                </div>`;
            });

            container.innerHTML = html;
        }

        // ---- Open verify card ----
        function qbOpenVerify(sku) {
            qbVerifyingSKU  = sku;
            const item      = qbCurrentSession.items.find(i => i.sku === sku);
            if (!item) return;

            document.getElementById('qbVerifySKU').textContent  = item.sku;
            document.getElementById('qbVerifyDesc').textContent = item.description || '‚Äî';
            document.getElementById('qbVerifyQBQty').textContent = item.qbQty;
            document.getElementById('qbVerifyITQty').textContent = item.itQty !== null ? item.itQty : '‚Äî';
            document.getElementById('qbVerifyNotes').value       = item.notes || '';
            document.getElementById('qbVerifyLocationBadge').textContent = item.location ? 'üìç ' + item.location : '';

            // Prefill actual count: if previously verified use that, otherwise use InvenTrack qty
            const defaultCount = item.verified ? item.actualQty : (item.itQty !== null ? item.itQty : 0);
            document.getElementById('qbActualCount').value = defaultCount !== null ? defaultCount : 0;

            // Show blank variance for now (update on input)
            qbUpdateVerifyVariance();

            const card = document.getElementById('qbVerifyCard');
            card.style.display = 'flex';

            // Update variance live
            document.getElementById('qbActualCount').oninput = qbUpdateVerifyVariance;
        }

        function qbUpdateVerifyVariance() {
            const item      = qbCurrentSession ? qbCurrentSession.items.find(i => i.sku === qbVerifyingSKU) : null;
            const actualQty = parseInt(document.getElementById('qbActualCount').value) || 0;
            const qbQty     = item ? item.qbQty : 0;
            const variance  = actualQty - qbQty;

            const box   = document.getElementById('qbVerifyVarianceBox');
            const label = document.getElementById('qbVerifyVarianceLabel');
            const val   = document.getElementById('qbVerifyVarianceVal');

            val.textContent  = (variance > 0 ? '+' : '') + variance;
            label.textContent = 'Variance';

            if (variance === 0) {
                box.style.background = '#d1fae5'; box.style.color = '#065f46';
                val.style.color = '#065f46'; label.style.color = '#065f46';
            } else {
                box.style.background = '#fee2e2'; box.style.color = '#991b1b';
                val.style.color = '#991b1b'; label.style.color = '#991b1b';
            }
        }

        function qbAdjustCount(delta) {
            const input = document.getElementById('qbActualCount');
            const val   = parseInt(input.value) || 0;
            input.value = Math.max(0, val + delta);
            qbUpdateVerifyVariance();
        }

        function qbCancelVerify() {
            document.getElementById('qbVerifyCard').style.display = 'none';
            qbVerifyingSKU = null;
        }

        async function qbSaveVerify() {
            const sku       = qbVerifyingSKU;
            const actualQty = parseInt(document.getElementById('qbActualCount').value) || 0;
            const notes     = document.getElementById('qbVerifyNotes').value.trim();

            const item  = qbCurrentSession.items.find(i => i.sku === sku);
            if (!item) return;

            item.verified   = true;
            item.actualQty  = actualQty;
            item.variance   = actualQty - item.qbQty;
            item.notes      = notes;
            item.verifiedAt = new Date().toISOString();

            document.getElementById('qbVerifyCard').style.display = 'none';
            qbVerifyingSKU = null;

            // Save to cloud
            try {
                await qbSaveSessionToCloud(qbCurrentSession);
            } catch(e) {
                console.error('Cloud save after verify error:', e);
            }

            qbUpdateProgress();
            qbRenderList();
            showNotification('‚úì Verified: ' + sku + (item.variance !== 0 ? ' ‚ö†Ô∏è Variance: ' + (item.variance > 0 ? '+' : '') + item.variance : ' ‚úì Match'));
        }

        // ---- Finish session ----
        async function qbFinishSession() {
            if (!qbCurrentSession) return;
            const total    = qbCurrentSession.items.length;
            const verified = qbCurrentSession.items.filter(i => i.verified).length;

            if (verified === 0) {
                showNotification('No items verified yet', 'error');
                return;
            }

            if (verified < total) {
                if (!confirm(verified + ' of ' + total + ' items verified. Finish anyway?\n\nUnverified items will be listed as pending in the report.')) return;
            }

            showLoading(true, 'Finalizing session...');
            try {
                qbCurrentSession.status     = 'finished';
                qbCurrentSession.finishedAt = new Date().toISOString();
                await qbMarkSessionFinished(qbCurrentSession.id);
                qbShowResults();
            } catch(e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ---- Results screen ----
        function qbShowResults() {
            document.getElementById('qbSessionScreen').style.display  = 'none';
            document.getElementById('qbResultsScreen').style.display  = 'block';

            const session    = qbCurrentSession;
            const total      = session.items.length;
            const verified   = session.items.filter(i => i.verified).length;
            const matches    = session.items.filter(i => i.verified && i.variance === 0).length;
            const diffs      = session.items.filter(i => i.verified && i.variance !== 0).length;
            const pending    = total - verified;

            document.getElementById('qbResultsTitle').textContent = session.name;
            document.getElementById('qbResultsDate').textContent  = 'Finished: ' + new Date().toLocaleString();

            document.getElementById('qbResultsSummary').innerHTML =
                qbStatBox(total,    'üì¶', 'Total',   '#f8fafc', '#1e293b') +
                qbStatBox(matches,  '‚úì',  'Match',   '#d1fae5', '#065f46') +
                qbStatBox(diffs,    '‚ö†Ô∏è', 'Differ',  '#fee2e2', '#991b1b');

            // Discrepancy detail
            const diffItems = session.items.filter(i => i.verified && i.variance !== 0);
            const pendItems = session.items.filter(i => !i.verified);

            let html = '';
            if (diffItems.length > 0) {
                html += '<h3 style="font-size:15px; font-weight:700; margin-bottom:10px; color:#991b1b;">‚ö†Ô∏è Discrepancies (' + diffItems.length + ')</h3>';
                diffItems.forEach(item => {
                    html += `<div style="background:#fff5f5; border:1px solid #fecaca; border-radius:8px; padding:12px; margin-bottom:8px;">
                        <div style="font-weight:700; color:#1e293b; margin-bottom:4px;">${item.sku}</div>
                        <div style="font-size:13px; color:#64748b; margin-bottom:6px;">${item.description || ''}</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:13px;">
                            <div><strong>QB:</strong> ${item.qbQty}</div>
                            <div><strong>Physical:</strong> ${item.actualQty}</div>
                            <div style="color:#991b1b;"><strong>Variance:</strong> ${item.variance > 0 ? '+' : ''}${item.variance}</div>
                        </div>
                        ${item.notes ? `<div style="font-size:12px; color:#64748b; margin-top:6px; font-style:italic;">üìù ${item.notes}</div>` : ''}
                    </div>`;
                });
            }

            if (pendItems.length > 0) {
                html += '<h3 style="font-size:15px; font-weight:700; margin-bottom:10px; margin-top:16px; color:#64748b;">‚è≥ Not Verified (' + pendItems.length + ')</h3>';
                pendItems.forEach(item => {
                    html += `<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-bottom:8px;">
                        <div style="font-weight:700; color:#64748b;">${item.sku}</div>
                        <div style="font-size:13px; color:#94a3b8;">${item.description || ''} &nbsp;|&nbsp; QB Qty: ${item.qbQty}</div>
                    </div>`;
                });
            }

            document.getElementById('qbResultsDetail').innerHTML = html;
        }

        function qbStatBox(value, icon, label, bg, color) {
            return `<div style="background:${bg}; padding:14px; border-radius:10px; text-align:center;">
                <div style="font-size:22px; margin-bottom:4px;">${icon}</div>
                <div style="font-size:24px; font-weight:800; color:${color};">${value}</div>
                <div style="font-size:12px; color:${color}; font-weight:600; margin-top:2px;">${label}</div>
            </div>`;
        }

        // ---- Export CSV ----
        function qbExportResults() {
            if (!qbCurrentSession) return;
            const session = qbCurrentSession;
            let csv = 'QB Reconcile Report\n';
            csv += 'Session: ' + session.name + '\n';
            csv += 'Date: ' + new Date().toLocaleString() + '\n\n';
            csv += 'SKU,Description,Location,QB_Qty,InvenTrack_Qty,Physical_Count,Variance,Status,Notes,Verified_At\n';

            session.items.forEach(item => {
                const status = !item.verified ? 'PENDING' : (item.variance === 0 ? 'MATCH' : 'DISCREPANCY');
                csv += `"${item.sku}","${item.description || ''}","${item.location || ''}",`;
                csv += `${item.qbQty},${item.itQty !== null ? item.itQty : ''},`;
                csv += `${item.verified ? item.actualQty : ''},`;
                csv += `${item.verified ? item.variance : ''},`;
                csv += `"${status}","${item.notes || ''}","${item.verifiedAt ? new Date(item.verifiedAt).toLocaleString() : ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href     = url;
            a.download = 'QB_Reconcile_' + session.name.replace(/\s+/g, '_') + '_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Report exported!');
        }

        function qbNewSession() {
            qbCurrentSession = null;
            document.getElementById('qbResultsScreen').style.display  = 'none';
            document.getElementById('qbSessionScreen').style.display  = 'none';
            document.getElementById('qbUploadScreen').style.display   = 'block';
            document.getElementById('qbCSVPaste').value               = '';
            document.getElementById('qbSessionName').value            = '';
            document.getElementById('qbFileStatus').style.display     = 'none';
            document.getElementById('qbCSVFile').value                = '';
            qbInitTab();
        }

        // END QB RECONCILE
        // ============================================================

        // ============================================================
        //  AUTH - Login / Logout / Session
        // ============================================================

        let currentUser     = null;
        let currentUserRole = 'employee';
        let currentUserName = 'User';

        async function initAuth() {
            // Check for existing session
            const { data: { session } } = await db.auth.getSession();
            if (session && session.user) {
                await onSignedIn(session.user);
            } else {
                showLoginScreen();
            }

            // Listen for auth changes
            db.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    await onSignedIn(session.user);
                } else if (event === 'SIGNED_OUT') {
                    showLoginScreen();
                }
            });
        }

        async function onSignedIn(user) {
            currentUser = user;
            // Load user profile for name + role
            try {
                const { data, error } = await db
                    .from('user_profiles')
                    .select('display_name, role')
                    .eq('id', user.id)
                    .single();

                if (data) {
                    currentUserRole = data.role;
                    currentUserName = data.display_name;
                }
            } catch(e) {
                console.error('Profile load error:', e);
            }

            // Update menu user info
            const nameEl = document.getElementById('menuUserName');
            const roleEl = document.getElementById('menuUserRole');
            if (nameEl) nameEl.textContent = currentUserName;
            if (roleEl) roleEl.textContent = currentUserRole === 'manager' ? '‚≠ê Manager' : 'üë∑ Employee';

            // Role-based menu visibility
            const employeeTabs = ['dashboard', 'tasks', 'inventory', 'stock-entry', 'add-edit', 'qb-reconcile'];
            document.querySelectorAll('.menu-item').forEach(item => {
                const tab = item.getAttribute('data-tab');
                if (!tab) return; // skip section headers
                if (currentUserRole === 'manager') {
                    item.style.display = '';
                } else {
                    item.style.display = employeeTabs.includes(tab) ? '' : 'none';
                }
            });

            // Show app, hide login
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Load inventory
            await loadInventory();

            // Restore last active tab (fall back to dashboard if employee can't access it)
            const lastTab = localStorage.getItem('lastActiveTab') || 'dashboard';
            const canAccess = currentUserRole === 'manager' || employeeTabs.includes(lastTab);
            switchToTab(canAccess ? lastTab : 'dashboard');
        }

        function showLoginScreen() {
            const ls = document.getElementById('loginScreen');
            ls.style.display    = 'flex';
            ls.style.alignItems = 'center';
            ls.style.justifyContent = 'center';
            document.getElementById('app').style.display = 'none';
            currentUser     = null;
            currentUserRole = 'employee';
            currentUserName = 'User';
        }

        async function doLogin() {
            const email    = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn      = document.getElementById('loginBtn');
            const errDiv   = document.getElementById('loginError');

            if (!email || !password) {
                errDiv.textContent = 'Please enter your email and password.';
                errDiv.style.display = 'block';
                return;
            }

            btn.textContent = 'Signing in...';
            btn.disabled = true;
            errDiv.style.display = 'none';

            try {
                const { data, error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // onAuthStateChange will fire and call onSignedIn
            } catch(e) {
                errDiv.textContent = e.message.includes('Invalid') ? 'Incorrect email or password.' : e.message;
                errDiv.style.display = 'block';
                btn.textContent = 'Sign In';
                btn.disabled = false;
            }
        }

        async function doSignOut() {
            await db.auth.signOut();
            // Close menu
            document.getElementById('menuOverlay').style.display = 'none';
            document.getElementById('menuPanel').style.transform = 'translateX(-100%)';
            // Clear fields and go to login
            document.getElementById('loginEmail').value    = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginBtn').textContent = 'Sign In';
            document.getElementById('loginBtn').disabled   = false;
            showLoginScreen();
        }

        async function doPasswordReset() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                document.getElementById('loginError').textContent = 'Enter your email above first, then click Forgot password.';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            const { error } = await db.auth.resetPasswordForEmail(email);
            if (!error) {
                document.getElementById('loginError').style.background = '#d1fae5';
                document.getElementById('loginError').style.color = '#065f46';
                document.getElementById('loginError').style.borderColor = '#6ee7b7';
                document.getElementById('loginError').textContent = 'Password reset email sent! Check your inbox.';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Start auth check on load
        initAuth();

        // ============================================================
        //  TASKS
        // ============================================================

        let tasksList      = [];
        let tasksFilter    = 'all';
        let tasksEditingId = null;   // null = creating new
        let tasksCurrentId = null;   // task open in detail view

        const TASK_STATUS_CONFIG = {
            not_started:  { label: 'Not Started', color: '#64748b', bg: '#f1f5f9', icon: '‚¨ú' },
            in_progress:  { label: 'In Progress', color: '#1d4ed8', bg: '#dbeafe', icon: 'üîµ' },
            needs_review: { label: 'Needs Review', color: '#92400e', bg: '#fef3c7', icon: 'üü°' },
            completed:    { label: 'Completed',   color: '#065f46', bg: '#d1fae5', icon: '‚úÖ' }
        };

        const TASK_PRIORITY_CONFIG = {
            low:    { label: 'Low',    color: '#065f46', bg: '#d1fae5', icon: 'üü¢' },
            medium: { label: 'Medium', color: '#92400e', bg: '#fef3c7', icon: 'üü°' },
            high:   { label: 'High',   color: '#991b1b', bg: '#fee2e2', icon: 'üî¥' }
        };

        async function tasksInit() {
            // Show/hide manager controls
            const isManager = currentUserRole === 'manager';
            const mgrBar = document.getElementById('tasksManagerBar');
            if (mgrBar) mgrBar.style.display = isManager ? 'block' : 'none';

            // Completed button only for managers
            const completedBtn = document.getElementById('tsBtnCompleted');
            if (completedBtn) {
                if (isManager) {
                    completedBtn.style.color = '#64748b';
                    completedBtn.onclick = () => tasksSetStatus('completed');
                } else {
                    completedBtn.style.opacity = '0.4';
                    completedBtn.style.cursor  = 'not-allowed';
                    completedBtn.title = 'Only managers can mark tasks complete';
                }
            }

            await tasksLoad();
        }

        async function tasksLoad() {
            try {
                const { data, error } = await db
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                tasksList = data || [];
                tasksRenderList();
            } catch(e) {
                showNotification('Error loading tasks: ' + e.message, 'error');
            }
        }

        function tasksSetFilter(f) {
            tasksFilter = f;
            // Update filter button styles
            const map = { all: 'tfAll', not_started: 'tfNot', in_progress: 'tfIn', needs_review: 'tfRev', completed: 'tfDone' };
            Object.entries(map).forEach(([key, id]) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                const active = key === f;
                btn.style.background   = active ? '#3b82f6' : 'white';
                btn.style.color        = active ? 'white'   : '#64748b';
                btn.style.borderColor  = active ? '#3b82f6' : '#e2e8f0';
            });
            tasksRenderList();
        }

        function tasksRenderList() {
            let items = tasksFilter === 'all'
                ? tasksList
                : tasksList.filter(t => t.status === tasksFilter);

            const container = document.getElementById('tasksList');
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:48px 20px; color:#94a3b8; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">' +
                    (tasksFilter === 'all' ? '‚úÖ No tasks yet' : 'No tasks in this category') + '</div>';
                return;
            }

            // Group by status order
            const order = ['not_started', 'in_progress', 'needs_review', 'completed'];
            if (tasksFilter !== 'all') {
                // Single filter ‚Äî just list
                container.innerHTML = items.map(t => tasksCardHTML(t)).join('');
                return;
            }

            // All ‚Äî group by status
            let html = '';
            order.forEach(status => {
                const group = items.filter(t => t.status === status);
                if (group.length === 0) return;
                const cfg = TASK_STATUS_CONFIG[status];
                html += `<div style="margin-bottom:6px; padding:8px 12px; background:${cfg.bg}; border-radius:8px; font-size:12px; font-weight:800; color:${cfg.color}; text-transform:uppercase; letter-spacing:1px;">${cfg.icon} ${cfg.label} (${group.length})</div>`;
                html += group.map(t => tasksCardHTML(t)).join('');
            });
            container.innerHTML = html;
        }

        function tasksCardHTML(task) {
            const sc  = TASK_STATUS_CONFIG[task.status]   || TASK_STATUS_CONFIG.not_started;
            const pc  = TASK_PRIORITY_CONFIG[task.priority] || TASK_PRIORITY_CONFIG.medium;
            const prefixCount = task.brand_prefix
                ? inventory.filter(i => i.sku.toUpperCase().startsWith(task.brand_prefix.toUpperCase())).length
                : 0;

            return `<div onclick="tasksOpenDetail('${task.id}')" style="background:white; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:10px; cursor:pointer; border-left:4px solid ${sc.color};">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="font-size:16px; font-weight:700; color:#1e293b; flex:1; margin-right:10px;">${task.title}</div>
                    <span style="padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; background:${pc.bg}; color:${pc.color}; white-space:nowrap;">${pc.icon} ${pc.label}</span>
                </div>
                ${task.notes ? `<div style="font-size:13px; color:#64748b; margin-bottom:8px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${task.notes}</div>` : ''}
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; background:${sc.bg}; color:${sc.color};">${sc.icon} ${sc.label}</span>
                    ${task.brand_prefix ? `<span style="font-size:12px; color:#3b82f6; font-weight:600;">üì¶ ${task.brand_prefix} ¬∑ ${prefixCount} SKUs</span>` : ''}
                </div>
            </div>`;
        }

        function tasksOpenCreate() {
            tasksEditingId = null;
            document.getElementById('tasksFormTitle').textContent = 'New Task';
            document.getElementById('taskTitle').value       = '';
            document.getElementById('taskNotes').value       = '';
            document.getElementById('taskPriority').value   = 'medium';
            document.getElementById('taskBrandPrefix').value = '';
            document.getElementById('taskBrandInfo').style.display = 'none';
            document.getElementById('tasksListScreen').style.display = 'none';
            document.getElementById('tasksFormScreen').style.display = 'block';
        }

        function tasksCloseForm() {
            document.getElementById('tasksFormScreen').style.display = 'none';
            document.getElementById('tasksListScreen').style.display = 'block';
        }

        async function tasksSave() {
            const title  = document.getElementById('taskTitle').value.trim();
            if (!title) { showNotification('Task title is required', 'error'); return; }

            const prefix = document.getElementById('taskBrandPrefix').value.trim().toUpperCase() || null;
            const payload = {
                title:        title,
                notes:        document.getElementById('taskNotes').value.trim() || null,
                priority:     document.getElementById('taskPriority').value,
                brand_prefix: prefix,
                updated_at:   new Date().toISOString()
            };

            try {
                showLoading(true, 'Saving task...');
                if (tasksEditingId) {
                    const { error } = await db.from('tasks').update(payload).eq('id', tasksEditingId);
                    if (error) throw error;
                } else {
                    payload.status     = 'not_started';
                    payload.created_by = currentUser.id;
                    const { error } = await db.from('tasks').insert(payload);
                    if (error) throw error;
                }
                await tasksLoad();
                tasksCloseForm();
                showNotification(tasksEditingId ? 'Task updated!' : 'Task created!');
            } catch(e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function tasksOpenDetail(taskId) {
            const task = tasksList.find(t => String(t.id) === String(taskId));
            if (!task) return;
            tasksCurrentId = task.id;

            const sc = TASK_STATUS_CONFIG[task.status]    || TASK_STATUS_CONFIG.not_started;
            const pc = TASK_PRIORITY_CONFIG[task.priority] || TASK_PRIORITY_CONFIG.medium;

            // Priority badge
            const pb = document.getElementById('tasksDetailPriorityBadge');
            pb.textContent       = pc.icon + ' ' + pc.label + ' Priority';
            pb.style.background  = pc.bg;
            pb.style.color       = pc.color;

            document.getElementById('tasksDetailTitle').textContent = task.title;
            document.getElementById('tasksDetailNotes').textContent = task.notes || 'No instructions provided.';

            // Brand prefix info
            const bb = document.getElementById('tasksDetailBrandBadge');
            if (task.brand_prefix) {
                const count = inventory.filter(i => i.sku.toUpperCase().startsWith(task.brand_prefix.toUpperCase())).length;
                bb.style.display = 'block';
                bb.innerHTML = `<span style="background:#dbeafe; color:#1e40af; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:700;">üì¶ ${task.brand_prefix} ‚Äî ${count} SKUs in system</span>`;
            } else {
                bb.style.display = 'none';
            }

            // Manager buttons
            const isManager = currentUserRole === 'manager';
            const mgrBtns   = document.getElementById('tasksDetailManagerBtns');
            if (mgrBtns) mgrBtns.style.display = isManager ? 'flex' : 'none';

            // Highlight current status button
            tasksHighlightStatusBtn(task.status);

            document.getElementById('tasksListScreen').style.display   = 'none';
            document.getElementById('tasksDetailScreen').style.display = 'block';
        }

        function tasksHighlightStatusBtn(status) {
            const btns = {
                not_started:  'tsBtnNotStarted',
                in_progress:  'tsBtnInProgress',
                needs_review: 'tsBtnNeedsReview',
                completed:    'tsBtnCompleted'
            };
            Object.entries(btns).forEach(([s, id]) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                const cfg    = TASK_STATUS_CONFIG[s];
                const active = s === status;
                btn.style.background  = active ? cfg.bg  : 'white';
                btn.style.borderColor = active ? cfg.color : '#e2e8f0';
                btn.style.color       = active ? cfg.color : '#64748b';
                btn.style.fontWeight  = active ? '800' : '700';
            });
        }

        function tasksCloseDetail() {
            document.getElementById('tasksDetailScreen').style.display = 'none';
            document.getElementById('tasksListScreen').style.display   = 'block';
            tasksCurrentId = null;
        }

        async function tasksSetStatus(newStatus) {
            if (!tasksCurrentId) return;
            // Employees can't complete
            if (newStatus === 'completed' && currentUserRole !== 'manager') {
                showNotification('Only managers can mark tasks complete', 'error');
                return;
            }
            try {
                const { error } = await db.from('tasks')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', tasksCurrentId);
                if (error) throw error;

                // Update local list
                const task = tasksList.find(t => String(t.id) === String(tasksCurrentId));
                if (task) task.status = newStatus;

                tasksHighlightStatusBtn(newStatus);
                const sc = TASK_STATUS_CONFIG[newStatus];
                showNotification(sc.icon + ' ' + sc.label);
            } catch(e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        function tasksEditCurrent() {
            const task = tasksList.find(t => String(t.id) === String(tasksCurrentId));
            if (!task) return;
            tasksEditingId = task.id;
            document.getElementById('tasksFormTitle').textContent  = 'Edit Task';
            document.getElementById('taskTitle').value             = task.title;
            document.getElementById('taskNotes').value             = task.notes || '';
            document.getElementById('taskPriority').value         = task.priority || 'medium';
            document.getElementById('taskBrandPrefix').value       = task.brand_prefix || '';
            document.getElementById('tasksDetailScreen').style.display = 'none';
            document.getElementById('tasksFormScreen').style.display   = 'block';
        }

        async function tasksDeleteCurrent() {
            if (!tasksCurrentId) return;
            const task = tasksList.find(t => String(t.id) === String(tasksCurrentId));
            if (!confirm('Delete task "' + (task ? task.title : '') + '"? This cannot be undone.')) return;
            try {
                showLoading(true, 'Deleting...');
                const { error } = await db.from('tasks').delete().eq('id', tasksCurrentId);
                if (error) throw error;
                tasksCurrentId = null;
                await tasksLoad();
                tasksCloseDetail();
                showNotification('Task deleted');
            } catch(e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // END TASKS
        // ============================================================

    </script>
</body>
</html>
